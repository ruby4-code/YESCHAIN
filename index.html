import React, { useState, useEffect, useRef } from 'react';
import { 
  Home, Activity, Heart, BookOpen, User, Bell, 
  ChevronRight, Phone, MessageCircle, Calendar, 
  Award, Settings, LogOut, CheckCircle, Circle, 
  AlertCircle, Send, X, MapPin, Clock, Plus,
  FileText, Share2, Download, Pill, Utensils, Moon, 
  Dumbbell, TrendingUp, Users, Shield, CreditCard,
  Target, Zap, Coffee, Gift, Percent, FileCheck, Sparkles, Loader,
  ShoppingBag, Ticket, Wallet, CheckSquare, ScanLine, Tag, Copy, 
  HelpCircle, ExternalLink, ThumbsUp, ChevronLeft, Search, Star,
  Smile, ArrowUp, ArrowDown, Printer, AlertTriangle, Package, Lightbulb, Info, UserPlus, Mail, PhoneCall,
  Coins, QrCode
} from 'lucide-react';
import { 
  LineChart, Line, XAxis, YAxis, CartesianGrid, 
  Tooltip, ResponsiveContainer, AreaChart, Area, Legend, BarChart, Bar
} from 'recharts';

// --- å…¨åŸŸè¨­å®š ---
const BRAND_COLOR = '#027377'; 
const ACCENT_COLOR = '#F59E0B'; 
const MAX_DAILY_POINTS = 30;
const TODAY_DATE = '2025-12-19';

// --- æ¨¡æ“¬æ•¸æ“šèˆ‡è¨­å®š ---
const generateLongTermData = () => {
  const data = [];
  // ä¿®æ”¹ï¼šé è¨­è³‡æ–™åªç”Ÿæˆåˆ° 12/18ï¼Œç•™ç©º 12/19 çµ¦ä½¿ç”¨è€…è¼¸å…¥
  const endDate = new Date('2025-12-18'); 
  const startDate = new Date(endDate);
  startDate.setDate(endDate.getDate() - 100); 

  for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
    const dateStr = d.toISOString().split('T')[0];
    const daySeed = d.getTime(); 
    
    data.push({
      fullDate: dateStr,
      date: dateStr.slice(5),
      sys: 120 + Math.floor(Math.sin(daySeed) * 10) + 5,
      dia: 80 + Math.floor(Math.cos(daySeed) * 5),
      sugar: 100 + Math.floor(Math.random() * 20) - 5,
      weight: 68 - ((d - startDate) / (1000 * 60 * 60 * 24)) * 0.02 + (Math.random() * 0.2), 
      sleep: Number((6.5 + Math.random() * 2).toFixed(1)),
    });
  }
  return data;
};

// é€™æ˜¯åˆå§‹éœæ…‹æ•¸æ“šï¼Œå¾Œé¢æœƒè½‰ç‚º State
const initialHealthData = generateLongTermData();

const tasksMock = [
  { id: 1, text: 'æ¸¬é‡è¡€å£“ (æ—©)', type: 'health', completed: false, points: 5 }, 
  { id: 3, text: 'é£²é£Ÿç´€éŒ„ (åˆé¤)', type: 'diet', completed: false, points: 5 },
  { id: 4, text: 'å¥èµ° 30 åˆ†é˜', type: 'exercise', completed: false, points: 10 },
  { id: 5, text: 'æ¸¬é‡è¡€ç³– (é£¯å¾Œ)', type: 'sugar', completed: false, points: 5 },
];

const medicationInitial = [
  { id: 1, name: 'é™è¡€å£“è—¥ (Amlodipine)', dosage: 1, unit: 'é¡†', time: '08:00', frequency: 'æ¯æ—¥ä¸€æ¬¡', stock: 4, taken: false },
  { id: 2, name: 'ç¶­ç”Ÿç´  B ç¾¤', dosage: 1, unit: 'éŒ ', time: '12:00', frequency: 'æ¯æ—¥ä¸€æ¬¡', stock: 20, taken: false },
];

// åˆå§‹å…±äº«è³‡æ–™
const initialSharedWithMe = [
  { id: 'u1', name: 'æ—ç¾ç ', relation: 'æ¯è¦ª', avatar: 'æ¯', status: 'active' }
];

const initialSharedWithOthers = [
  { id: 'u2', name: 'é™³å­è±ª', relation: 'å…’å­', status: 'active', avatar: 'å­' }
];

// æ“´å……å ±å‘Šæ•¸æ“š
const reportsMock = [
  { 
    id: 1, 
    title: '2025å¹´11æœˆ å¥åº·æœˆå ±', 
    date: '2025/12/01', 
    rangeStart: '2025-11-01', 
    rangeEnd: '2025-11-30',
    score: 88,
    summary: 'è¡€å£“æ§åˆ¶å¹³ç©©ï¼Œç¡çœ å“è³ªæå‡ï¼Œè«‹ç¹¼çºŒä¿æŒï¼',
    goals: { bp: 95, sugar: 80, exercise: 60 },
    advice: {
      lifestyle: 'å…¥å†¬æº«å·®å¤§ï¼Œæ—©æ™¨èµ·åºŠè«‹è¨˜å¾—æ·»åŠ è¡£ç‰©ï¼Œé¿å…å†·ç©ºæ°£åˆºæ¿€è¡€ç®¡ã€‚',
      diet: 'æœ¬æœˆéˆ‰æ”å–é‡ç•¥é«˜ï¼Œå»ºè­°æ¸›å°‘ç«é‹æ¹¯åº•èˆ‡æ²¾é†¬çš„ä½¿ç”¨ï¼Œå¤šæ”å–æ·±ç¶ è‰²è”¬èœã€‚',
      exercise: 'æ­¥è¡Œæ•¸é”æ¨™ç‡ 60%ï¼Œå»ºè­°æ™šé¤å¾Œå¯å¢åŠ  15 åˆ†é˜å¿«èµ°ã€‚'
    },
    tasks: { completed: 120, missed: 0, totalPoints: 855 } 
  },
  { 
    id: 2, 
    title: '2025å¹´10æœˆ å¥åº·æœˆå ±', 
    date: '2025/11/01', 
    rangeStart: '2025-10-01', 
    rangeEnd: '2025-10-31',
    score: 82,
    summary: 'è¡€ç³–æ³¢å‹•è¼ƒå¤§ï¼Œéœ€æ³¨æ„æ¾±ç²‰æ”å–ã€‚',
    goals: { bp: 90, sugar: 70, exercise: 85 },
    advice: {
      lifestyle: 'ç¡çœ æ™‚é–“è¼ƒä¸å›ºå®šï¼Œå»ºè­°è¨­å®šé¬§é˜æé†’å°±å¯¢ã€‚',
      diet: 'æ¸›å°‘ç²¾ç·»æ¾±ç²‰ï¼ˆå¦‚éºµåŒ…ã€è›‹ç³•ï¼‰ï¼Œæ”¹ä»¥åœ°ç“œæˆ–ç³™ç±³é£¯ç‚ºä¸»é£Ÿã€‚',
      exercise: 'é‹å‹•è¡¨ç¾å„ªç•°ï¼Œè«‹ç¶­æŒç›®å‰çš„é‹å‹•å¼·åº¦ã€‚'
    },
    tasks: { completed: 110, missed: 20, totalPoints: 745 }
  },
];

const couponsMock = [
  { id: 'c1', title: 'NT$ 100 æŠ˜åƒ¹åˆ¸', cost: 500, desc: 'æ»¿ $1000 å¯ä½¿ç”¨', type: 'coupon' },
  { id: 'c2', title: 'NT$ 200 æŠ˜åƒ¹åˆ¸', cost: 1000, desc: 'æ»¿ $2000 å¯ä½¿ç”¨', type: 'coupon' },
  { id: 'c3', title: 'NT$ 500 æŠ˜åƒ¹åˆ¸', cost: 1400, desc: 'æ»¿ $4000 å¯ä½¿ç”¨', type: 'coupon' },
];

const giftsMock = [
  { id: 'g1', title: 'ç¶œåˆç¶­ä»–å‘½ (7æ—¥ä»½)', cost: 200, desc: 'è£œå……æ¯æ—¥æ‰€éœ€ç‡Ÿé¤Š', icon: 'ğŸ’Š', type: 'gift' },
  { id: 'g2', title: 'Bç¾¤æ´»åŠ›éŒ  (30æ—¥ä»½)', cost: 2000, desc: 'å¢å¼·é«”åŠ›ç²¾ç¥æ—ºç››', icon: 'âš¡ï¸', type: 'gift' },
  { id: 'g3', title: 'å„ªè³ªç›Šç”ŸèŒ (30æ—¥ä»½)', cost: 2000, desc: 'èª¿æ•´é«”è³ªå¹«åŠ©æ¶ˆåŒ–', icon: 'ğŸ¦ ', type: 'gift' },
];

const healthArticles = [
  { id: 1, title: 'æˆ‘éœ€è¦è£œå……Bç¾¤å—ï¼Ÿå°šæ©è—¥å¸«è§£ç­”ç¼ºä¹Bç¾¤çš„5å¤§ç—‡ç‹€', tag: 'Bç¾¤', url: 'https://www.yesnet.com.tw/blogs/%E8%97%A5%E5%B8%AB%E6%95%99%E4%BD%A0%E9%81%B8/145435', image: null },
  { id: 2, title: 'è‘‰é»ƒç´ å¤§è§£å¯†ï¼å®œå©·è—¥å¸«ä¾†è§£æƒ‘ï¼', tag: 'è‘‰é»ƒç´ ', url: 'https://www.yesnet.com.tw/blogs/%E8%97%A5%E5%B8%AB%E6%95%99%E4%BD%A0%E9%81%B8/145436', image: null },
  { id: 3, title: 'å¦‚ä½•æœ‰æ•ˆç·©è§£èƒƒé£Ÿé“é€†æµèˆ‡èƒƒè„¹æ°£å•é¡Œ', tag: 'è…¸èƒƒå¥åº·', url: 'https://www.yesnet.com.tw/blogs/%E8%97%A5%E5%B8%AB%E6%95%99%E4%BD%A0%E9%81%B8/154665', image: null },
  { id: 4, title: 'é—œç¯€ä¿å¥å“æ€éº¼é¸ï¼Ÿ', tag: 'é—œç¯€ä¿é¤Š', url: 'https://www.yesnet.com.tw/blogs/%E8%97%A5%E5%B8%AB%E6%95%99%E4%BD%A0%E9%81%B8/159988', image: null },
  { id: 5, title: 'ç”˜è‹¦äººé›†åˆï¼è­·è‚ä¿å¥é€™æ¨£åƒï¼', tag: 'è­·è‚', url: 'https://www.yesnet.com.tw/blogs/%E8%97%A5%E5%B8%AB%E6%95%99%E4%BD%A0%E9%81%B8/163878', image: null },
  { id: 6, title: 'å®¹æ˜“ç´¯ã€çˆ¬ä¸€å±¤æ¨“å°±æœƒå–˜ï¼Ÿå¯èƒ½æ˜¯èº«é«”ç¼ºä¹Q10ï¼', tag: 'å¿ƒè‚ºåŠŸèƒ½', url: 'https://www.yesnet.com.tw/blogs/%E8%97%A5%E5%B8%AB%E6%95%99%E4%BD%A0%E9%81%B8/172587', image: null },
  { id: 7, title: 'ç¡ä¸å¥½æƒ³è£œå……é‚ï¼Ÿé¸å°å‹æ…‹å¾ˆé‡è¦ï¼', tag: 'ç¡çœ å“è³ª', url: 'https://www.yesnet.com.tw/blogs/%E8%97%A5%E5%B8%AB%E6%95%99%E4%BD%A0%E9%81%B8/177100', image: null },
];

const chatbotOptions = [
  { label: 'é ­æšˆå¯èƒ½æ˜¯ä»€éº¼åŸå› ï¼Ÿ', response: 'å¸¸è¦‹åŸå› åŒ…å«ä½è¡€å£“ã€è„«æ°´ã€ç¡çœ ä¸è¶³æˆ–è¡€ç³–æ³¢å‹•ã€‚æˆ‘å¯ä»¥å¹«ä½ å¿«é€Ÿæª¢æŸ¥æœ€è¿‘çš„ç´€éŒ„ï¼Œæˆ–æä¾›ä½ éœ€è¦ç«‹å³ç•™æ„çš„è­¦è¨Šã€‚' },
  { label: 'æˆ‘å¿˜è¨˜åƒè¡€å£“è—¥äº†æ€éº¼è¾¦ï¼Ÿ', response: 'ä¸€èˆ¬å»ºè­°åœ¨æƒ³èµ·æ™‚ç›¡å¿«è£œåƒï¼Œä½†è‹¥å·²æ¥è¿‘ä¸‹ä¸€æ¬¡æœç”¨æ™‚é–“ï¼Œè«‹å‹¿é‡è¤‡åŠ é‡ã€‚æˆ‘å¯ä»¥ä¾ä½ çš„æœè—¥ç´€éŒ„æä¾›æœ€å®‰å…¨çš„è™•ç†æ–¹å¼ã€‚' },
  { label: 'é€™å€‹è—¥å¯ä»¥è·Ÿç¶­ä»–å‘½ä¸€èµ·åƒå—ï¼Ÿ', response: 'æ ¹æ“šè—¥ç‰©æˆåˆ†èˆ‡å¸¸è¦‹ç‡Ÿé¤Šå“çš„äº¤äº’ä½œç”¨åˆ¤æ–·ï¼Œå¤šæ•¸ç¶­ä»–å‘½å¯èˆ‡æ­¤è—¥ç‰©ä½µç”¨ï¼Œä½†å»ºè­°é–“éš”è‡³å°‘ä¸€å°æ™‚ã€‚' },
  { label: 'æœ€è¿‘ç¡çœ å¥½åƒè®Šå·®', response: 'æ ¹æ“šç´€éŒ„ï¼Œä½ éå»ä¸ƒå¤©å¹³å‡ç¡ 5.6 å°æ™‚ï¼Œæ¯”å‰ä¸€é€±ä¸‹é™ã€‚æˆ‘å¯ä»¥æä¾›æ”¹å–„å»ºè­°ï¼Œæˆ–å»ºç«‹ã€Œå›ºå®šç¡çœ æé†’ã€ã€‚' },
  { label: 'æˆ‘æ™šé¤åƒæ»·è‚‰é£¯æœƒå½±éŸ¿è¡€å£“å—ï¼Ÿ', response: 'æ»·è‚‰é£¯çš„æ²¹è„‚èˆ‡éˆ‰å«é‡åé«˜ï¼Œå¯èƒ½è®“è¡€å£“åœ¨çŸ­æœŸä¸Šå‡ã€‚æˆ‘å¯ä»¥ç‚ºä½ æä¾›æ›´å¥åº·çš„æ›¿ä»£å»ºè­°ï¼Œæˆ–åŠ å…¥ã€Œé£²é£Ÿç´€éŒ„ã€ã€‚' },
  { label: 'ä»Šå¤©ä¸æƒ³é‹å‹•ï¼Œæœ‰ä»€éº¼è¼•é¬†çš„é¸æ“‡ï¼Ÿ', response: 'æˆ‘ç‚ºä½ æ¨è–¦ä¼¸å±•ã€10 åˆ†é˜å¿«èµ°æˆ–æ·±å‘¼å¸ç·©å’Œè¨“ç·´ã€‚è¦ä¸è¦å¹«ä½ åŠ å…¥ä»Šæ—¥ä»»å‹™ï¼Ÿ' },
];

// é€šçŸ¥æ•¸æ“š 
const notificationsInitial = [
  { 
    id: 105, 
    title: 'âš ï¸ å®¶äººè¡€ç³–ç•°å¸¸è­¦ç¤º', 
    desc: 'æ‚¨çš„å…±äº«å°è±¡ã€Œæ—ç¾ç  (æ¯è¦ª)ã€å‰›ä¸Šå‚³çš„é£¯å¾Œè¡€ç³–å€¼ç‚º 210 mg/dLï¼Œå·²é«˜æ–¼æ¨™æº–ç¯„åœã€‚å»ºè­°æ‚¨æ’¥é›»è©±é—œå¿ƒï¼Œæˆ–æé†’å¥¹æ³¨æ„ä¸‹ä¸€é¤çš„é£²é£Ÿã€‚', 
    time: 'å‰›å‰›', 
    type: 'alert', 
    read: false 
  },
  { 
    id: 999, 
    title: 'ğŸ“© å…±äº«é‚€è«‹é€šçŸ¥', 
    desc: 'æ—å¤§è¯ (æ‚¨çš„å…„å¼Ÿ) é‚€è«‹ä½ æˆç‚ºä»–çš„å¥åº·æ•¸æ“šå…±äº«è€…ï¼Œä½ å°‡èƒ½æª¢è¦–ä»–çš„å¥åº·ç´€éŒ„èˆ‡æœˆå ±ã€‚', 
    time: 'å‰›å‰›', 
    type: 'invite', 
    payload: { name: 'æ—å¤§è¯', relation: 'å…„å¼Ÿ', id: 'u3' },
    read: false 
  },
  { 
    id: 101, 
    title: 'âš ï¸ è¡€å£“æ•¸æ“šç•°å¸¸æé†’', 
    desc: 'ä»Šæ—¥æ—©ä¸Šæ¸¬é‡æ”¶ç¸®å£“ç‚º 145 mmHgï¼Œç•¥é«˜æ–¼æ¨™æº–ã€‚å»ºè­°ä¼‘æ¯ 15 åˆ†é˜å¾Œé‡æ–°æ¸¬é‡ï¼Œè‹¥æŒçºŒåé«˜è«‹è«®è©¢è—¥å¸«ã€‚', 
    time: '08:15', 
    type: 'alert', 
    read: false 
  },
  { 
    id: 102, 
    title: 'ğŸ“¦ ä¿å¥å“è£œå……æé†’', 
    desc: 'æ‚¨çš„ã€Œæ·±æµ·é­šæ²¹ (Omega-3)ã€åº«å­˜åƒ…å‰© 5 å¤©ä»½ï¼Œè«‹è¨˜å¾—æœ¬é€±è‡³é–€å¸‚é ˜å–æ–°ä¸€å­£è£œçµ¦å“ã€‚', 
    time: '09:00', 
    type: 'refill', 
    read: false 
  },
  { 
    id: 103, 
    title: 'ğŸ’¡ å¥åº·è¡Œç‚ºå»ºè­°', 
    desc: 'ä¾æ“šè¿‘æœŸæ•¸æ“šï¼Œæ‚¨çš„é£¯å¾Œè¡€ç³–æ³¢å‹•ç¨å¤§ã€‚è—¥å¸«å»ºè­°ï¼šæ™šé¤å¾Œå¯é€²è¡Œ 15-20 åˆ†é˜çš„è¼•é¬†æ•£æ­¥ï¼Œæœ‰åŠ©æ–¼ç©©å®šæ•¸å€¼ã€‚', 
    time: 'æ˜¨å¤©', 
    type: 'advice', 
    read: false 
  },
  { 
    id: 1, 
    title: 'ğŸ’Œ æ‚¨çš„ 11æœˆå¥åº·æœˆå ± å·²ç”Ÿæˆ', 
    desc: 'è¦ªæ„›çš„ï¼Œä¸Šå€‹æœˆçš„å¥åº·å ±å‘Šå‡ºä¾†å›‰ï¼è¡€å£“æ§åˆ¶å¾—ä¸éŒ¯ï¼Œè—¥å¸«æœ‰äº›æ–°çš„é£²é£Ÿå»ºè­°çµ¦æ‚¨ï¼Œå¿«ä¾†çœ‹çœ‹å§ã€‚', 
    time: 'æ˜¨å¤©', 
    type: 'report', 
    relatedId: 1, 
    read: false 
  },
];

// ---------------------- ç¨ç«‹å…ƒä»¶å€ ----------------------

const TopBar = ({ title, showUser = false, onBack = null, rightAction = null, points = 0, onNotificationClick, unreadCount = 0 }) => (
  <div className="w-full h-14 flex items-center justify-between px-4 shadow-md z-30 sticky top-0" style={{ backgroundColor: BRAND_COLOR }}>
    <div className="flex items-center space-x-2">
      {onBack && <button onClick={onBack} className="text-white p-1 hover:bg-white/10 rounded-full"><ChevronRight className="rotate-180" /></button>}
      {showUser && (
        <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white font-bold border border-white/30">
          é™³
        </div>
      )}
      <h1 className="text-white text-lg font-bold tracking-wide truncate">{title}</h1>
    </div>
    <div className="flex space-x-3 items-center">
      {/* é€šçŸ¥éˆ´éº */}
      <button onClick={onNotificationClick} className="relative p-1 text-white hover:bg-white/10 rounded-full transition">
        <Bell size={22} />
        {unreadCount > 0 && (
          <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 border-2 border-teal-800 rounded-full"></span>
        )}
      </button>

      <div className="flex items-center bg-black/20 px-2 py-1 rounded-full">
          <span className="text-xs text-yellow-300 font-bold mr-1">P</span>
          <span className="text-white text-xs font-bold">{points}</span>
      </div>
      {rightAction}
    </div>
  </div>
);

const SectionHeader = ({ icon: Icon, title, actionText, onAction }) => (
  <div className="flex justify-between items-center mb-3 mt-6 px-1">
    <h3 className="font-bold text-gray-800 flex items-center text-lg">
      {Icon && <Icon size={20} className="mr-2" style={{color: BRAND_COLOR}} />}
      {title}
    </h3>
    {actionText && (
      <button onClick={onAction} className="text-xs text-gray-500 hover:text-teal-600 transition flex items-center">
        {actionText} <ChevronRight size={12} className="ml-0.5"/>
      </button>
    )}
  </div>
);

const ActionButton = ({ icon: Icon, label, onClick, colorClass = "bg-white text-gray-700" }) => (
  <button onClick={onClick} className={`flex flex-col items-center justify-center p-3 rounded-xl shadow-sm border border-gray-100 transition active:scale-95 ${colorClass}`}>
    <div className={`w-10 h-10 rounded-full flex items-center justify-center mb-2 bg-opacity-20 ${colorClass.includes('text-white') ? 'bg-white/20' : 'bg-gray-100'}`}>
      <Icon size={20} />
    </div>
    <span className="text-xs font-bold text-center leading-tight">{label}</span>
  </button>
);

// --- Notification View ---
const NotificationView = ({ onBack, onOpenReport, onInviteClick, points, notifications, setNotifications, setActiveTab }) => {
  const handleNotifClick = (notif) => {
    // æ¨™è¨˜ç‚ºå·²è®€
    setNotifications(prev => prev.map(n => n.id === notif.id ? {...n, read: true} : n));

    if (notif.type === 'report') {
       onOpenReport(notif.relatedId);
    } else if (notif.type === 'invite') {
       onInviteClick(notif);
    } else if (notif.type === 'refill') {
       // è·³è½‰è‡³æ–¹æ¡ˆé é¢
       setActiveTab('plan');
    }
    // ä¿®æ”¹ï¼šå°æ–¼ alert å’Œ adviceï¼Œé»æ“Šå¾Œä¸è·³è½‰ï¼Œåƒ…æ¨™è¨˜å·²è®€ (ç”±ä¸Šæ–¹ setNotifications è™•ç†)
  };

  return (
    <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
      <TopBar title="é€šçŸ¥ä¸­å¿ƒ" onBack={onBack} points={points} />
      <div className="p-4 space-y-3">
        {notifications.map(notif => (
          <div 
            key={notif.id} 
            onClick={() => handleNotifClick(notif)}
            className={`bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden transition 
              cursor-pointer hover:shadow-md active:scale-[0.99]
              ${notif.type === 'report' ? 'border-l-4 border-l-teal-500' : ''}
              ${notif.type === 'alert' ? 'border-l-4 border-l-red-500 bg-red-50/30' : ''}
              ${notif.type === 'invite' ? 'border-l-4 border-l-blue-500 bg-blue-50/30' : ''}
              ${notif.type === 'refill' ? 'border-l-4 border-l-orange-400 bg-orange-50/30' : ''}
              ${notif.type === 'advice' ? 'border-l-4 border-l-indigo-400 bg-indigo-50/30' : ''}
              ${notif.read ? 'opacity-60 grayscale-[0.5]' : ''} 
            `}
          >
            {!notif.read && <div className="absolute right-2 top-2 w-2 h-2 bg-red-500 rounded-full"></div>}
            <div className="flex items-start">
              <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 mr-3 
                ${notif.type === 'report' ? 'bg-teal-50 text-teal-600' : 
                  notif.type === 'invite' ? 'bg-blue-100 text-blue-600' :
                  notif.type === 'medication' ? 'bg-blue-50 text-blue-600' :
                  notif.type === 'alert' ? 'bg-red-100 text-red-600' : 
                  notif.type === 'refill' ? 'bg-orange-100 text-orange-600' :
                  notif.type === 'advice' ? 'bg-indigo-100 text-indigo-600' :
                  notif.type === 'task' ? 'bg-orange-50 text-orange-600' : 'bg-gray-100 text-gray-500'}`}>
                {notif.type === 'report' ? <FileText size={20}/> : 
                 notif.type === 'invite' ? <UserPlus size={20}/> :
                 notif.type === 'medication' ? <Pill size={20}/> : 
                 notif.type === 'alert' ? <AlertTriangle size={20}/> :
                 notif.type === 'refill' ? <Package size={20}/> :
                 notif.type === 'advice' ? <Lightbulb size={20}/> :
                 notif.type === 'task' ? <Award size={20}/> : <Bell size={20}/>}
              </div>
              <div className="flex-1">
                <div className="flex justify-between items-start mb-1">
                  <h4 className={`font-bold text-sm ${notif.read ? 'text-gray-700' : 'text-gray-900'}`}>{notif.title}</h4>
                  <span className="text-[10px] text-gray-400">{notif.time}</span>
                </div>
                <p className="text-xs text-gray-500 leading-relaxed">{notif.desc}</p>
                {notif.type === 'report' && (
                   <div className="mt-2 text-xs font-bold text-teal-600 flex items-center">
                     é»æ“ŠæŸ¥çœ‹å®Œæ•´å ±å‘Š <ChevronRight size={12}/>
                   </div>
                )}
                {notif.type === 'invite' && (
                   <div className="mt-2 text-xs font-bold text-blue-600 flex items-center">
                     é»æ“ŠæŸ¥çœ‹é‚€è«‹è©³æƒ… <ChevronRight size={12}/>
                   </div>
                )}
                {notif.type === 'refill' && (
                   <button className="mt-2 text-xs font-bold text-orange-600 bg-white border border-orange-200 px-2 py-1 rounded shadow-sm">
                     æŸ¥çœ‹æœ¬å­£é…ç½®
                   </button>
                )}
                {(notif.type === 'alert' || notif.type === 'advice') && (
                   <div className="mt-2">
                     {!notif.read ? (
                       <button className="text-xs font-bold text-white bg-teal-600 px-4 py-1.5 rounded-lg shadow-sm active:scale-95 transition">
                         ç¢ºèª
                       </button>
                     ) : (
                       <span className="text-xs font-bold text-gray-400 flex items-center">
                          <CheckCircle size={14} className="mr-1"/> å·²ç¢ºèª
                       </span>
                     )}
                   </div>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// --- Sub-Views for Health Records ---

const BloodPressureView = ({ onBack, onSave, healthData, points }) => {
  const [sys, setSys] = useState('');
  const [dia, setDia] = useState('');
  return (
    <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
      <TopBar title="è¡€å£“ç´€éŒ„" onBack={onBack} points={points} />
      <div className="p-4 space-y-6">
        <div className="bg-white p-5 rounded-2xl shadow-sm">
          <h3 className="font-bold text-gray-800 mb-4">è¼¸å…¥ä»Šæ—¥æ•¸æ“š (12/19)</h3>
          <div className="flex space-x-4 mb-4">
            <div className="flex-1"><label className="text-xs text-gray-500 mb-1 block">æ”¶ç¸®å£“ (mmHg)</label><input type="number" value={sys} onChange={e=>setSys(e.target.value)} className="w-full bg-gray-50 p-3 rounded-lg border focus:outline-none text-center text-xl font-bold" placeholder="120" /></div>
            <div className="flex-1"><label className="text-xs text-gray-500 mb-1 block">èˆ’å¼µå£“ (mmHg)</label><input type="number" value={dia} onChange={e=>setDia(e.target.value)} className="w-full bg-gray-50 p-3 rounded-lg border focus:outline-none text-center text-xl font-bold" placeholder="80" /></div>
          </div>
          <button onClick={()=>onSave(sys, dia)} className="w-full py-3 rounded-xl text-white font-bold bg-teal-600 shadow-md active:scale-95 transition">ç¢ºèªå„²å­˜</button>
        </div>
        <div className="bg-white p-4 rounded-xl shadow-sm">
           <h3 className="font-bold text-gray-800 mb-4">è¿‘ 30 å¤©è¶¨å‹¢</h3>
           <div className="h-60 w-full"><ResponsiveContainer><LineChart data={healthData.slice(-30)}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="date" tick={{fontSize:10}} interval={6} /><YAxis domain={[60, 160]} tick={{fontSize:10}} /><Tooltip /><Legend /><Line type="monotone" dataKey="sys" name="æ”¶ç¸®å£“" stroke="#EF4444" strokeWidth={2} dot={false} /><Line type="monotone" dataKey="dia" name="èˆ’å¼µå£“" stroke="#3B82F6" strokeWidth={2} dot={false} /></LineChart></ResponsiveContainer></div>
        </div>
      </div>
    </div>
  );
};

const BloodSugarView = ({ onBack, onSave, healthData, points }) => {
  const [sugar, setSugar] = useState('');
  return (
    <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
      <TopBar title="è¡€ç³–ç´€éŒ„" onBack={onBack} points={points} />
      <div className="p-4 space-y-6">
        <div className="bg-white p-5 rounded-2xl shadow-sm"><h3 className="font-bold text-gray-800 mb-4">è¼¸å…¥é£¯å¾Œè¡€ç³– (12/19)</h3><input type="number" value={sugar} onChange={e=>setSugar(e.target.value)} className="w-full bg-gray-50 p-3 rounded-lg border focus:outline-none text-center text-xl font-bold mb-4" placeholder="mg/dL" /><button onClick={()=>onSave(sugar)} className="w-full py-3 rounded-xl text-white font-bold bg-blue-600 shadow-md active:scale-95 transition">ç¢ºèªå„²å­˜</button></div>
        <div className="bg-white p-4 rounded-xl shadow-sm"><h3 className="font-bold text-gray-800 mb-4">è¿‘ 30 å¤©è¶¨å‹¢</h3><div className="h-60 w-full"><ResponsiveContainer><AreaChart data={healthData.slice(-30)}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="date" tick={{fontSize:10}} /><YAxis domain={[80, 160]} tick={{fontSize:10}} /><Tooltip /><Area type="monotone" dataKey="sugar" name="è¡€ç³–" stroke="#3B82F6" fill="#BFDBFE" /></AreaChart></ResponsiveContainer></div></div>
      </div>
    </div>
  );
};

const WeightView = ({ onBack, onSave, healthData, points }) => {
  const [weight, setWeight] = useState('');
  return (
  <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
    <TopBar title="é«”é‡ç´€éŒ„" onBack={onBack} points={points} />
    <div className="p-4 space-y-6">
      <div className="bg-white p-5 rounded-2xl shadow-sm"><h3 className="font-bold text-gray-800 mb-4">è¼¸å…¥ä»Šæ—¥é«”é‡ (12/19)</h3><input type="number" value={weight} onChange={e=>setWeight(e.target.value)} className="w-full bg-gray-50 p-3 rounded-lg border focus:outline-none text-center text-xl font-bold mb-4" placeholder="kg" /><button onClick={()=>onSave(weight)} className="w-full py-3 rounded-xl text-white font-bold bg-yellow-500 shadow-md active:scale-95 transition">ç¢ºèªå„²å­˜</button></div>
      <div className="bg-white p-4 rounded-xl shadow-sm"><h3 className="font-bold text-gray-800 mb-4">è¿‘ 30 å¤©è¶¨å‹¢ (å¹³ç©©)</h3><div className="h-60 w-full"><ResponsiveContainer><LineChart data={healthData.slice(-30)}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="date" tick={{fontSize:10}} /><YAxis domain={[60, 75]} tick={{fontSize:10}} /><Tooltip /><Line type="monotone" dataKey="weight" name="é«”é‡" stroke="#EAB308" strokeWidth={2} dot={false} /></LineChart></ResponsiveContainer></div></div>
    </div>
  </div>
)};

// æ–°å¢ï¼šç¡çœ ç´€éŒ„è¦–åœ–
const SleepView = ({ onBack, onSave, healthData, points }) => {
  const [sleep, setSleep] = useState('');
  return (
  <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
    <TopBar title="ç¡çœ ç´€éŒ„" onBack={onBack} points={points} />
    <div className="p-4 space-y-6">
      <div className="bg-white p-5 rounded-2xl shadow-sm">
        <h3 className="font-bold text-gray-800 mb-4">æ˜¨æ™šç¡äº†å¤šä¹…ï¼Ÿ (12/19)</h3>
        <input type="number" value={sleep} onChange={e=>setSleep(e.target.value)} className="w-full bg-gray-50 p-3 rounded-lg border focus:outline-none text-center text-xl font-bold mb-4" placeholder="å°æ™‚ (ä¾‹å¦‚: 7.5)" step="0.5" />
        <button onClick={()=>onSave(sleep)} className="w-full py-3 rounded-xl text-white font-bold bg-indigo-500 shadow-md active:scale-95 transition">ç¢ºèªå„²å­˜</button>
      </div>
      <div className="bg-white p-4 rounded-xl shadow-sm">
        <h3 className="font-bold text-gray-800 mb-4">è¿‘ 30 å¤©ç¡çœ è¶¨å‹¢</h3>
        <div className="h-60 w-full">
          <ResponsiveContainer>
            <BarChart data={healthData.slice(-30)}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} />
              <XAxis dataKey="date" tick={{fontSize:10}} />
              <YAxis domain={[0, 12]} tick={{fontSize:10}} />
              <Tooltip />
              <Bar dataKey="sleep" name="ç¡çœ æ™‚æ•¸" fill="#818cf8" radius={[4, 4, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </div>
    </div>
  </div>
)};

const DietView = ({ onBack, onSave, points }) => (
  <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
    <TopBar title="é£²é£Ÿç´€éŒ„" onBack={onBack} points={points} />
    <div className="p-4 space-y-4">
      <div className="bg-white p-5 rounded-2xl shadow-sm space-y-4"><div><label className="text-sm font-bold text-gray-700 mb-1 block">é£²é£Ÿå…§å®¹</label><input type="text" className="w-full p-3 bg-gray-50 border rounded-xl" placeholder="ä¾‹å¦‚ï¼šé›è…¿ä¾¿ç•¶ã€ç„¡ç³–ç¶ èŒ¶" /></div><div className="grid grid-cols-2 gap-4"><div><label className="text-sm font-bold text-gray-700 mb-1 block">ä»½é‡</label><select className="w-full p-3 bg-gray-50 border rounded-xl"><option>æ­£å¸¸</option><option>å°‘é‡</option><option>å¤šé‡</option></select></div><div><label className="text-sm font-bold text-gray-700 mb-1 block">æ™‚é–“</label><input type="time" className="w-full p-3 bg-gray-50 border rounded-xl" defaultValue="12:00" /></div></div><button onClick={onSave} className="w-full py-3 rounded-xl text-white font-bold bg-green-600 shadow-md active:scale-95 transition">è¨˜éŒ„é£²é£Ÿ</button></div>
      <div className="text-center text-gray-400 mt-10"><Utensils size={48} className="mx-auto mb-2 opacity-20" /><p>ä»Šæ—¥å°šæœªæœ‰é£²é£Ÿç´€éŒ„</p></div>
    </div>
  </div>
);

const ExerciseView = ({ onBack, onSave, points }) => (
  <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
    <TopBar title="é‹å‹•ç´€éŒ„" onBack={onBack} points={points} />
    <div className="p-4 space-y-4">
      <div className="bg-white p-5 rounded-2xl shadow-sm space-y-4"><div><label className="text-sm font-bold text-gray-700 mb-1 block">é‹å‹•é¡å‹</label><select className="w-full p-3 bg-gray-50 border rounded-xl"><option>å¥èµ°</option><option>æ…¢è·‘</option><option>çˆ¬å±±</option><option>æ¸¸æ³³</option><option>ç‘œçˆ</option><option>ç¾½æ¯›çƒ</option><option>é¨è…³è¸è»Š</option></select></div><div><label className="text-sm font-bold text-gray-700 mb-1 block">æ™‚é•· (åˆ†é˜)</label><input type="number" className="w-full p-3 bg-gray-50 border rounded-xl" placeholder="30" /></div><button onClick={onSave} className="w-full py-3 rounded-xl text-white font-bold bg-orange-500 shadow-md active:scale-95 transition">è¨˜éŒ„é‹å‹•</button></div>
    </div>
  </div>
);

const MedicationRecordView = ({ onBack, medications, points }) => {
  const weekDays = [{d:'14',w:'æ—¥',a:false},{d:'15',w:'ä¸€',a:false},{d:'16',w:'äºŒ',a:false},{d:'17',w:'ä¸‰',a:false},{d:'18',w:'å››',a:false},{d:'19',w:'äº”',a:true},{d:'20',w:'å…­',a:false}];
  return (
    <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
      <TopBar title="ç”¨è—¥ç´€éŒ„æ—¥æ›†" onBack={onBack} points={points} />
      <div className="bg-white shadow-sm pb-4"><div className="flex justify-between items-center p-4 border-b border-gray-100"><button><ChevronLeft/></button><h3 className="font-bold text-gray-800">2025å¹´ 12æœˆ</h3><button><ChevronRight/></button></div><div className="flex justify-around pt-4 px-2">{weekDays.map((day, i) => (<div key={i} className={`flex flex-col items-center p-2 rounded-xl ${day.a ? 'bg-teal-600 text-white shadow-md' : 'text-gray-500'}`}><span className="text-xs mb-1">{day.w}</span><span className="font-bold text-lg">{day.d}</span>{day.a && <span className="w-1.5 h-1.5 bg-white rounded-full mt-1"></span>}</div>))}</div></div>
      <div className="p-4 space-y-3"><h4 className="font-bold text-gray-700 ml-1">ä»Šæ—¥ç”¨è—¥ (12/19)</h4>{medications.map(med => (<div key={med.id} className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500 flex justify-between items-center"><div><p className="font-bold text-gray-800">{med.name}</p><p className="text-xs text-gray-500">{med.time} â€¢ {med.dosage} {med.unit}</p></div><div className={`px-3 py-1 rounded text-xs font-bold ${med.taken ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-400'}`}>{med.taken ? 'å·²æœç”¨' : 'æœªæœç”¨'}</div></div>))}{medications.length === 0 && <p className="text-center text-gray-400 py-10">ä»Šæ—¥ç„¡ç”¨è—¥æé†’</p>}</div>
    </div>
  );
};

// --- æœˆå ± Modals: ç°¡å–®ç‰ˆ (ç´€éŒ„å€) vs è©³ç´°ç‰ˆ (é€šçŸ¥å€) ---

// 1. ç°¡å–®ç‰ˆæœˆå ± Modal (æ¢å¾©æˆä¹‹å‰çš„æ¨£å¼)
const SimpleReportModal = ({ report, onClose, longTermData, points }) => {
  if (!report) return null;
  const monthData = longTermData.filter(d => d.fullDate >= report.rangeStart && d.fullDate <= report.rangeEnd);
  const avgSys = Math.round(monthData.reduce((acc, curr) => acc + curr.sys, 0) / monthData.length) || 0;
  const avgSugar = Math.round(monthData.reduce((acc, curr) => acc + curr.sugar, 0) / monthData.length) || 0;

  return (
    <div className="fixed inset-0 z-[80] bg-gray-50 flex flex-col animate-slide-up">
       <TopBar title={report.title} onBack={onClose} points={points} rightAction={<button><Download className="text-white"/></button>} />
       <div className="flex-1 overflow-y-auto p-4 space-y-6">
          <div className="grid grid-cols-2 gap-4">
             <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500">
                <p className="text-xs text-gray-500">å¹³å‡æ”¶ç¸®å£“</p>
                <p className="text-2xl font-bold text-gray-800">{avgSys} <span className="text-xs font-normal">mmHg</span></p>
             </div>
             <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                <p className="text-xs text-gray-500">å¹³å‡é£¯å¾Œè¡€ç³–</p>
                <p className="text-2xl font-bold text-gray-800">{avgSugar} <span className="text-xs font-normal">mg/dL</span></p>
             </div>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
             <h3 className="font-bold text-gray-800 mb-4 flex items-center">è¡€å£“è¶¨å‹¢</h3>
             <div className="h-48 w-full"><ResponsiveContainer><LineChart data={monthData}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="date" tick={{fontSize:10}} interval={4} /><YAxis domain={[60, 160]} tick={{fontSize:10}} /><Tooltip /><Line type="monotone" dataKey="sys" stroke="#EF4444" strokeWidth={2} dot={false} /><Line type="monotone" dataKey="dia" stroke="#3B82F6" strokeWidth={2} dot={false} /></LineChart></ResponsiveContainer></div>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
             <h3 className="font-bold text-gray-800 mb-4 flex items-center">è¡€ç³–æ³¢å‹•</h3>
             <div className="h-48 w-full"><ResponsiveContainer><AreaChart data={monthData}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="date" tick={{fontSize:10}} interval={4} /><YAxis domain={[80, 140]} tick={{fontSize:10}} /><Tooltip /><Area type="monotone" dataKey="sugar" stroke="#F59E0B" fill="#FEF3C7" /></AreaChart></ResponsiveContainer></div>
          </div>
       </div>
    </div>
  );
};

// 2. è©³ç´°ç‰ˆæœˆå ± Modal (é€šçŸ¥ä¸­å¿ƒå°ˆç”¨)
const DetailedReportModal = ({ report, onClose, longTermData, points, showToast }) => {
  if (!report) return null;
  const monthData = longTermData.filter(d => d.fullDate >= report.rangeStart && d.fullDate <= report.rangeEnd);
  const avgSys = Math.round(monthData.reduce((acc, curr) => acc + curr.sys, 0) / monthData.length) || 0;
  const avgSugar = Math.round(monthData.reduce((acc, curr) => acc + curr.sugar, 0) / monthData.length) || 0;
  const avgSleep = (monthData.reduce((acc, curr) => acc + curr.sleep, 0) / monthData.length).toFixed(1) || 0;

  return (
    // ä¿®æ”¹: Z-Index æå‡ç‚º 100ï¼Œç¢ºä¿è¦†è“‹ SharedUserView (90)
    <div className="fixed inset-0 z-[100] bg-gray-50 flex flex-col animate-slide-up">
       <TopBar 
          title={report.title} 
          onBack={onClose} 
          points={points} 
          rightAction={
            <div className="flex space-x-2">
              <button onClick={() => showToast('å·²é€£æ¥å°è¡¨æ©Ÿ', 'success')} className="text-white opacity-80 hover:opacity-100"><Printer size={20}/></button>
              <button onClick={() => showToast('æ­£åœ¨ä¸‹è¼‰ PDF...', 'success')} className="text-white opacity-80 hover:opacity-100"><Download size={20}/></button>
            </div>
          } 
       />
       <div className="flex-1 overflow-y-auto pb-10">
          {/* å ±å‘Šé ­éƒ¨ï¼šæ‘˜è¦èˆ‡è©•åˆ† */}
          <div className="bg-teal-700 text-white p-6 rounded-b-3xl mb-4 relative overflow-hidden">
             <div className="relative z-10">
               <div className="flex justify-between items-start mb-4">
                 <div>
                   <h2 className="text-2xl font-bold mb-1">å¥åº·è©•åˆ†: {report.score}</h2>
                   <p className="text-teal-200 text-sm">{report.summary}</p>
                 </div>
                 <div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                   <Award size={32} className="text-yellow-300"/>
                 </div>
               </div>
               
               {/* é—œéµæŒ‡æ¨™æ‘˜è¦ */}
               <div className="flex justify-between text-center gap-2">
                 <div className="flex-1 bg-white/10 rounded-lg p-2">
                   <p className="text-xs text-teal-200 mb-1">å¹³å‡æ”¶ç¸®å£“</p>
                   <p className="font-bold text-lg">{avgSys}</p>
                 </div>
                 <div className="flex-1 bg-white/10 rounded-lg p-2">
                   <p className="text-xs text-teal-200 mb-1">å¹³å‡è¡€ç³–</p>
                   <p className="font-bold text-lg">{avgSugar}</p>
                 </div>
                 <div className="flex-1 bg-white/10 rounded-lg p-2">
                   <p className="text-xs text-teal-200 mb-1">å¹³å‡ç¡çœ </p>
                   <p className="font-bold text-lg">{avgSleep}h</p>
                 </div>
               </div>
             </div>
             {/* è£é£¾èƒŒæ™¯ */}
             <div className="absolute top-[-20%] right-[-10%] w-40 h-40 bg-teal-500 rounded-full opacity-30 blur-3xl"></div>
          </div>

          <div className="px-4 space-y-4">
            {/* 1. å¥åº·ç›®æ¨™é”æˆç‡ */}
            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
               <SectionHeader icon={Target} title="æœ¬æœˆç›®æ¨™é”æˆç‡" />
               <div className="space-y-4">
                 <div>
                   <div className="flex justify-between text-sm mb-1">
                     <span className="text-gray-600">è¡€å£“æ§åˆ¶ (ç›®æ¨™: 95%)</span>
                     <span className="font-bold text-teal-600">{report.goals.bp}%</span>
                   </div>
                   <div className="w-full bg-gray-100 rounded-full h-2">
                     <div className="bg-teal-500 h-2 rounded-full" style={{width: `${report.goals.bp}%`}}></div>
                   </div>
                 </div>
                 <div>
                   <div className="flex justify-between text-sm mb-1">
                     <span className="text-gray-600">è¡€ç³–ç©©å®š (ç›®æ¨™: 90%)</span>
                     <span className="font-bold text-blue-500">{report.goals.sugar}%</span>
                   </div>
                   <div className="w-full bg-gray-100 rounded-full h-2">
                     <div className="bg-blue-500 h-2 rounded-full" style={{width: `${report.goals.sugar}%`}}></div>
                   </div>
                 </div>
                 <div>
                   <div className="flex justify-between text-sm mb-1">
                     <span className="text-gray-600">é‹å‹•æ™‚æ•¸ (ç›®æ¨™: 100%)</span>
                     <span className={`font-bold ${report.goals.exercise < 80 ? 'text-orange-500' : 'text-green-500'}`}>{report.goals.exercise}%</span>
                   </div>
                   <div className="w-full bg-gray-100 rounded-full h-2">
                     <div className={`h-2 rounded-full ${report.goals.exercise < 80 ? 'bg-orange-500' : 'bg-green-500'}`} style={{width: `${report.goals.exercise}%`}}></div>
                   </div>
                 </div>
               </div>
            </div>

            {/* 2. è©³ç´°è¶¨å‹¢åœ–è¡¨ */}
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
               <h3 className="font-bold text-gray-800 mb-4 flex items-center"><Activity size={18} className="mr-2 text-teal-600"/> è©³ç´°æ•¸æ“šè¶¨å‹¢</h3>
               
               <div className="mb-6">
                 <p className="text-xs font-bold text-gray-500 mb-2">è¡€å£“è®ŠåŒ– (æ”¶ç¸®/èˆ’å¼µ)</p>
                 <div className="h-40 w-full"><ResponsiveContainer><LineChart data={monthData}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="date" tick={{fontSize:10}} interval={4} /><YAxis domain={[60, 160]} tick={{fontSize:10}} /><Tooltip /><Line type="monotone" dataKey="sys" stroke="#EF4444" strokeWidth={2} dot={false} /><Line type="monotone" dataKey="dia" stroke="#3B82F6" strokeWidth={2} dot={false} /></LineChart></ResponsiveContainer></div>
               </div>

               <div className="mb-6">
                 <p className="text-xs font-bold text-gray-500 mb-2">é£¯å¾Œè¡€ç³– (mg/dL)</p>
                 <div className="h-40 w-full"><ResponsiveContainer><AreaChart data={monthData}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="date" tick={{fontSize:10}} interval={4} /><YAxis domain={[80, 150]} tick={{fontSize:10}} /><Tooltip /><Area type="monotone" dataKey="sugar" stroke="#F59E0B" fill="#FEF3C7" /></AreaChart></ResponsiveContainer></div>
               </div>

               <div>
                 <p className="text-xs font-bold text-gray-500 mb-2">æ¯æ—¥ç¡çœ  (å°æ™‚)</p>
                 <div className="h-32 w-full"><ResponsiveContainer><BarChart data={monthData}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="date" tick={{fontSize:10}} interval={4} /><YAxis domain={[0, 10]} tick={{fontSize:10}} /><Tooltip /><Bar dataKey="sleep" fill="#6366f1" radius={[4, 4, 0, 0]} /></BarChart></ResponsiveContainer></div>
               </div>
            </div>

            {/* 3. è—¥å¸«å»ºè­° (é‡é») */}
            <div className="bg-gradient-to-br from-indigo-50 to-blue-50 p-5 rounded-xl border border-indigo-100">
               <SectionHeader icon={Sparkles} title="è—¥å¸«å°ˆå±¬å»ºè­°" />
               <div className="space-y-3">
                 <div className="flex gap-3 bg-white p-3 rounded-lg shadow-sm">
                    <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center shrink-0 text-blue-600"><Smile size={18}/></div>
                    <div>
                      <h4 className="text-sm font-bold text-gray-800">ä¸‹ä¸€éšæ®µç”Ÿæ´»èª¿æ•´</h4>
                      <p className="text-xs text-gray-600 mt-1 leading-relaxed">{report.advice.lifestyle}</p>
                    </div>
                 </div>
                 <div className="flex gap-3 bg-white p-3 rounded-lg shadow-sm">
                    <div className="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center shrink-0 text-green-600"><Utensils size={18}/></div>
                    <div>
                      <h4 className="text-sm font-bold text-gray-800">é£²é£Ÿå»ºè­°</h4>
                      <p className="text-xs text-gray-600 mt-1 leading-relaxed">{report.advice.diet}</p>
                    </div>
                 </div>
                 <div className="flex gap-3 bg-white p-3 rounded-lg shadow-sm">
                    <div className="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center shrink-0 text-orange-600"><Dumbbell size={18}/></div>
                    <div>
                      <h4 className="text-sm font-bold text-gray-800">é‹å‹•å»ºè­°</h4>
                      <p className="text-xs text-gray-600 mt-1 leading-relaxed">{report.advice.exercise}</p>
                    </div>
                 </div>
               </div>
            </div>

            {/* 4. ä»»å‹™èˆ‡ç©åˆ†å›é¡§ */}
            <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 mb-6">
              <SectionHeader icon={Award} title="æœ¬æœˆå¥åº·ä»»å‹™å›é¡§" />
              <div className="flex justify-between items-center bg-gray-50 p-4 rounded-lg mb-3">
                 <div className="text-center">
                   <p className="text-2xl font-bold text-gray-800">{report.tasks.totalPoints}</p>
                   <p className="text-xs text-gray-500">ç²å¾—ç©åˆ†</p>
                 </div>
                 <div className="h-8 w-[1px] bg-gray-200"></div>
                 <div className="text-center">
                   <p className="text-2xl font-bold text-green-600">{report.tasks.completed}</p>
                   <p className="text-xs text-gray-500">å®Œæˆä»»å‹™</p>
                 </div>
                 <div className="h-8 w-[1px] bg-gray-200"></div>
                 <div className="text-center">
                   <p className="text-2xl font-bold text-orange-500">{report.tasks.missed}</p>
                   <p className="text-xs text-gray-500">æœªé”æ¨™</p>
                 </div>
              </div>
            </div>

            {/* åº•éƒ¨æŒ‰éˆ• */}
            <div className="flex gap-3">
               <button onClick={() => showToast('å·²ä¸Šå‚³è‡³å…±äº«ç©ºé–“', 'success')} className="flex-1 py-3 bg-teal-600 text-white rounded-xl font-bold shadow-md flex items-center justify-center">
                  <Share2 size={18} className="mr-2"/> åˆ†äº«çµ¦å®¶äºº
               </button>
               <button onClick={() => showToast('PDF ä¸‹è¼‰ä¸­...', 'success')} className="flex-1 py-3 bg-white border border-gray-200 text-gray-700 rounded-xl font-bold flex items-center justify-center">
                  <Download size={18} className="mr-2"/> ä¸‹è¼‰å ±å‘Š
               </button>
            </div>
          </div>
       </div>
    </div>
  );
};


// --- Modals (Existing) ---
const BarcodeModal = ({ showBarcode, setShowBarcode }) => {
  if (!showBarcode) return null;
  return (
    <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-6 animate-fade-in" onClick={()=>setShowBarcode(null)}>
      <div className="bg-white w-full max-w-sm rounded-2xl overflow-hidden relative shadow-2xl" onClick={e => e.stopPropagation()}>
         <div className={`h-4 w-full ${showBarcode.type === 'coupon' ? 'bg-orange-500' : showBarcode.type === 'payment' ? 'bg-blue-600' : 'bg-teal-500'}`}></div>
         <div className="p-6 text-center">
            <h3 className="text-xl font-bold text-gray-800 mb-1">{showBarcode.title}</h3>
            <p className="text-sm text-gray-500 mb-6">{showBarcode.desc}</p>
            <div className="bg-gray-100 p-6 rounded-lg mb-6 border-2 border-dashed border-gray-300 relative group">
               <div className="h-24 w-full flex items-center justify-center space-x-1 overflow-hidden opacity-80 group-hover:opacity-100 transition">
                  {[...Array(40)].map((_, i) => (<div key={i} className={`h-full ${Math.random() > 0.5 ? 'w-1' : 'w-2'} bg-black`}></div>))}
               </div>
               <p className="text-sm font-mono mt-3 tracking-[0.2em] text-gray-600 font-bold">YES-{showBarcode.uid.toString().slice(-6)}</p>
            </div>
            <div className="flex items-start justify-center bg-yellow-50 p-4 rounded-lg text-left border border-yellow-200">
               <AlertCircle size={20} className="text-yellow-600 mr-3 shrink-0 mt-0.5"/>
               <p className="text-sm text-yellow-800 font-bold leading-relaxed">è«‹æ–¼çµå¸³æ™‚å‡ºç¤ºæ­¤æ¢ç¢¼çµ¦åº—å“¡æƒæï¼Œå³å¯å®Œæˆ{showBarcode.type === 'payment' ? 'æ”¯ä»˜' : 'å…Œæ›'}ã€‚</p>
            </div>
         </div>
         <button onClick={()=>setShowBarcode(null)} className="w-full py-4 bg-gray-50 text-gray-600 font-bold border-t border-gray-100 hover:bg-gray-100 transition">é—œé–‰è¦–çª—</button>
      </div>
    </div>
  );
};

// --- New Supplement Modal ---
const SupplementModal = ({ item, onClose }) => {
  if (!item) return null;
  return (
    <div className="fixed inset-0 z-[70] bg-black/60 flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
       <div className="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl relative" onClick={e => e.stopPropagation()}>
          <button onClick={onClose} className="absolute right-4 top-4 text-gray-400 hover:text-gray-600"><X size={20}/></button>
          <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center"><Pill className="mr-2 text-teal-600"/>{item.name}</h3>
          <div className="space-y-3 text-sm">
              <div><span className="font-bold text-gray-600 block mb-1">ä¿å¥å“èªªæ˜</span><p className="text-gray-500 bg-gray-50 p-2 rounded leading-relaxed">{item.desc}</p></div>
              <div><span className="font-bold text-gray-600 block mb-1">ä½¿ç”¨é »ç‡</span><p className="text-gray-500 bg-gray-50 p-2 rounded">{item.freq}</p></div>
              <div><span className="font-bold text-gray-600 block mb-1">å°æ‡‰æ”¹å–„é …ç›®</span><p className="text-teal-600 font-bold bg-teal-50 p-2 rounded">{item.target}</p></div>
          </div>
       </div>
    </div>
  )
}

const AddMedicationModal = ({ onClose, onAdd }) => {
  const [localName, setLocalName] = useState('');
  const [localTime, setLocalTime] = useState('08:00');
  const [localDosage, setLocalDosage] = useState(1);
  const [localStock, setLocalStock] = useState(30);
  const [localFreq, setLocalFreq] = useState('æ¯æ—¥ä¸€æ¬¡');
  const handleSubmit = () => { if (!localName) return; onAdd({ name: localName, time: localTime, dosage: localDosage, stock: localStock, frequency: localFreq }); };
  return (
    <div className="fixed inset-0 z-[60] bg-black/50 flex items-end sm:items-center justify-center animate-fade-in">
       <div className="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl">
          <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-xl text-gray-800">æ–°å¢ç”¨è—¥æé†’</h3><button onClick={onClose}><X size={24} className="text-gray-400"/></button></div>
          <div className="space-y-4">
             <div><label className="text-sm font-bold text-gray-600 mb-1 block">è—¥ç‰©åç¨±</label><input type="text" className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-teal-500 text-lg" placeholder="ä¾‹å¦‚ï¼šé™è¡€å£“è—¥" value={localName} onChange={(e) => setLocalName(e.target.value)} /></div>
             <div className="grid grid-cols-2 gap-4">
                <div><label className="text-sm font-bold text-gray-600 mb-1 block">é »ç‡</label><select className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none" value={localFreq} onChange={(e) => setLocalFreq(e.target.value)}><option>æ¯æ—¥ä¸€æ¬¡</option><option>æ¯æ—¥å…©æ¬¡</option><option>æ¯æ—¥ä¸‰æ¬¡</option><option>ç¡å‰æœç”¨</option></select></div>
                <div><label className="text-sm font-bold text-gray-600 mb-1 block">æ™‚é–“</label><input type="time" className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none" value={localTime} onChange={(e) => setLocalTime(e.target.value)} /></div>
             </div>
             <div className="grid grid-cols-2 gap-4">
                <div><label className="text-sm font-bold text-gray-600 mb-1 block">å–®æ¬¡åŠ‘é‡ (é¡†)</label><input type="number" className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none" value={localDosage} onChange={(e) => setLocalDosage(Number(e.target.value))} /></div>
                <div><label className="text-sm font-bold text-gray-600 mb-1 block">ç›®å‰æŒæœ‰ (é¡†)</label><input type="number" className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none" value={localStock} onChange={(e) => setLocalStock(Number(e.target.value))} /></div>
             </div>
             <button onClick={handleSubmit} className="w-full py-3.5 bg-teal-600 text-white rounded-xl font-bold shadow-lg hover:bg-teal-700 transition active:scale-95 mt-4">ç¢ºèªæ–°å¢</button>
          </div>
       </div>
    </div>
  );
};

const FamilyModal = ({ showFamilyModal, setShowFamilyModal, setShowFullReport, showToast }) => {
  if (!showFamilyModal) return null;
  return (
     <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4 animate-fade-in">
        <div className="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl">
           <div className="p-4 bg-teal-700 text-white flex justify-between items-center">
              <h3 className="font-bold text-lg">å®¶äººè©³ç´°è³‡æ–™</h3>
              <button onClick={()=>setShowFamilyModal(false)}><X size={20}/></button>
           </div>
           <div className="p-6 text-center">
              <div className="w-20 h-20 bg-gray-200 rounded-full mx-auto flex items-center justify-center text-3xl font-bold text-gray-500 mb-3 border-4 border-white shadow-md">æ¯</div>
              <h2 className="text-xl font-bold text-gray-800">æ—ç¾ç  (æ¯è¦ª)</h2>
              <p className="text-sm text-gray-500 mb-4">70 æ­² | èºç…å¥åº·åŒè¡Œ â€” 90å¤©æ”¹å–„è¨ˆç•«</p>
              <div className="bg-orange-50 p-3 rounded-lg mb-6 text-left border border-orange-100">
                 <p className="text-xs text-gray-500 mb-1">ä»Šæ—¥æ‘˜è¦</p>
                 <p className="text-sm font-bold text-orange-800">è¡€å£“æ­£å¸¸ (125/78)ï¼Œå°šæœªæœç”¨é™è¡€å£“è—¥ã€‚</p>
              </div>
              <div className="space-y-3">
                 <button onClick={()=>{setShowFamilyModal(false); setShowFullReport(true);}} className="w-full py-3 bg-teal-600 text-white rounded-xl font-bold shadow-md hover:bg-teal-700 transition flex items-center justify-center">
                    <FileText size={18} className="mr-2"/> æª¢è¦–è©³ç´°å¥åº·å ±å‘Š (3å€‹æœˆ)
                 </button>
                 <button onClick={()=>showToast('å ±å‘Š PDF ä¸‹è¼‰ä¸­...')} className="w-full py-3 bg-white border border-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-50 transition flex items-center justify-center">
                    <Download size={18} className="mr-2"/> ä¸‹è¼‰å ±å‘Š PDF
                 </button>
              </div>
           </div>
        </div>
     </div>
  );
};

const FullReportView = ({ showFullReport, setShowFullReport, showToast }) => {
  if (!showFullReport) return null;
  return (
     <div className="fixed inset-0 z-[70] bg-gray-50 flex flex-col animate-slide-up">
        <TopBar title="æ¯è¦ªçš„å¥åº·å ±å‘Š (è¿‘90å¤©)" onBack={() => setShowFullReport(false)} rightAction={<button onClick={()=>showToast('ä¸‹è¼‰ä¸­...')}><Download className="text-white"/></button>} />
        <div className="flex-1 overflow-y-auto p-4 space-y-6">
           <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <h3 className="font-bold text-gray-800 mb-4 flex items-center"><Activity size={18} className="mr-2 text-teal-600"/> è¡€å£“è¶¨å‹¢</h3>
              <div className="h-60 w-full">
                 <ResponsiveContainer>
                    <LineChart data={initialHealthData}>
                       <CartesianGrid strokeDasharray="3 3" vertical={false} />
                       <XAxis dataKey="date" tick={{fontSize:10}} interval={14} />
                       <YAxis domain={[60, 160]} tick={{fontSize:10}} />
                       <Tooltip />
                       <Legend />
                       <Line type="monotone" dataKey="sys" name="æ”¶ç¸®å£“" stroke="#EF4444" strokeWidth={2} dot={false} />
                       <Line type="monotone" dataKey="dia" name="èˆ’å¼µå£“" stroke="#3B82F6" strokeWidth={2} dot={false} />
                    </LineChart>
                 </ResponsiveContainer>
              </div>
           </div>
           <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <h3 className="font-bold text-gray-800 mb-4 flex items-center"><Utensils size={18} className="mr-2 text-orange-500"/> é£¯å¾Œè¡€ç³–</h3>
              <div className="h-48 w-full">
                 <ResponsiveContainer>
                    <AreaChart data={initialHealthData}>
                       <CartesianGrid strokeDasharray="3 3" vertical={false} />
                       <XAxis dataKey="date" tick={{fontSize:10}} interval={14} />
                       <YAxis domain={[80, 160]} tick={{fontSize:10}} />
                       <Tooltip />
                       <Area type="monotone" dataKey="sugar" name="è¡€ç³–" stroke="#F59E0B" fill="#FEF3C7" />
                    </AreaChart>
                 </ResponsiveContainer>
              </div>
           </div>
           <div className="grid grid-cols-2 gap-3">
              <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                 <h4 className="font-bold text-sm text-gray-700 mb-2">é«”é‡ (å¹³ç©©)</h4>
                 <div className="h-32 w-full">
                    <ResponsiveContainer>
                       <LineChart data={initialHealthData}>
                          <YAxis domain={[60, 75]} hide />
                          <Line type="monotone" dataKey="weight" stroke="#10B981" strokeWidth={2} dot={false} />
                       </LineChart>
                    </ResponsiveContainer>
                 </div>
              </div>
              <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                 <h4 className="font-bold text-sm text-gray-700 mb-2">å¹³å‡ç¡çœ </h4>
                 <div className="h-32 w-full flex items-center justify-center flex-col">
                    <Moon size={32} className="text-indigo-400 mb-2"/>
                    <span className="text-2xl font-bold text-gray-800">7.2</span>
                    <span className="text-xs text-gray-500">å°æ™‚/å¤©</span>
                 </div>
              </div>
           </div>
        </div>
     </div>
  );
};

const ChatOverlay = ({ showChat, setShowChat, chatMessages, handleOptionClick, chatEndRef }) => {
  if (!showChat) return null;
  return (
     <div className="fixed inset-0 z-50 bg-black/50 flex items-end justify-center" onClick={()=>setShowChat(false)}>
        <div className="bg-white w-full h-[70vh] rounded-t-2xl p-4 flex flex-col" onClick={e => e.stopPropagation()}>
           <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-gray-800 flex items-center"><Sparkles size={18} className="mr-2 text-yellow-500"/> AI è—¥å¸«åŠ©ç†</h3>
              <button onClick={()=>setShowChat(false)}><X size={20}/></button>
           </div>
           <div className="flex-1 bg-gray-50 rounded-xl p-4 mb-4 overflow-y-auto">
              {chatMessages.map((msg, i) => (
                 <div key={i} className={`mb-3 ${msg.sender === 'user' ? 'text-right' : 'text-left'}`}>
                    <span className={`inline-block p-3 rounded-2xl text-sm ${msg.sender === 'user' ? 'bg-teal-600 text-white' : 'bg-white border border-gray-200 text-gray-700'}`}>
                       {msg.text}
                    </span>
                 </div>
              ))}
              <div ref={chatEndRef}></div>
           </div>
           <div className="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto">
              {chatbotOptions.map((opt, i) => (
                 <button key={i} onClick={() => handleOptionClick(opt)} className="p-2 bg-white border border-teal-100 rounded-lg text-xs text-teal-700 font-bold hover:bg-teal-50 text-left transition">{opt.label}</button>
              ))}
           </div>
        </div>
     </div>
  )
}

// --- Invite Confirmation Modal ---
const InviteConfirmModal = ({ invite, onClose, onAccept, onDecline }) => {
  if (!invite) return null;
  return (
    <div className="fixed inset-0 z-[80] bg-black/60 flex items-center justify-center p-4 animate-fade-in">
       <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl relative">
          <button onClick={onClose} className="absolute right-4 top-4 text-gray-400 hover:text-gray-600"><X size={20}/></button>
          
          <div className="flex flex-col items-center text-center mb-6">
             <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mb-4 border-4 border-white shadow-md text-blue-600">
               <UserPlus size={40} />
             </div>
             <h3 className="text-xl font-bold text-gray-800 mb-1">{invite.payload.name}</h3>
             <p className="text-sm text-gray-500">é—œä¿‚ï¼š{invite.payload.relation}</p>
          </div>

          <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6 text-sm text-blue-900 leading-relaxed">
             <p className="font-bold mb-2">é‚€è«‹æ‚¨æˆç‚ºå¥åº·æ•¸æ“šå…±äº«è€…</p>
             <p className="text-xs text-blue-700 mb-2">æ‚¨å°‡èƒ½æª¢è¦–å°æ–¹çš„ï¼š</p>
             <ul className="list-disc pl-4 text-xs text-blue-700 space-y-1">
               <li>è¡€å£“ã€è¡€ç³–ã€ç¡çœ ç­‰å¥åº·ç´€éŒ„</li>
               <li>æ¯æœˆå¥åº·æœˆå ±</li>
               <li>ç›®å‰å¥åº·ç›®æ¨™èˆ‡é€²åº¦</li>
             </ul>
             <p className="text-[10px] text-gray-400 mt-3 pt-2 border-t border-blue-200">* åƒ…æä¾›æª¢è¦–æ¬Šé™ï¼Œä¸å¯ç·¨è¼¯æˆ–æ–°å¢è³‡æ–™ã€‚</p>
          </div>

          <div className="flex gap-3">
             <button onClick={() => onDecline(invite)} className="flex-1 py-3 border border-gray-300 text-gray-600 rounded-xl font-bold hover:bg-gray-50 transition">
               æ‹’çµ•
             </button>
             <button onClick={() => onAccept(invite)} className="flex-1 py-3 bg-teal-600 text-white rounded-xl font-bold shadow-md hover:bg-teal-700 transition">
               æ¥å—é‚€è«‹
             </button>
          </div>
       </div>
    </div>
  );
};

// --- Add Share Modal ---
const AddShareModal = ({ show, onClose, onAdd }) => {
  const [name, setName] = useState('');
  const [relation, setRelation] = useState('çˆ¶è¦ª');
  const [phone, setPhone] = useState('');
  const [phoneError, setPhoneError] = useState(false);

  // æ¸…ç©ºè¼¸å…¥å…§å®¹ç•¶ modal é—œé–‰æ™‚
  useEffect(() => {
    if (!show) {
      setName('');
      setRelation('çˆ¶è¦ª');
      setPhone('');
      setPhoneError(false);
    }
  }, [show]);

  if (!show) return null;

  const handleSubmit = () => {
    const phoneRegex = /^\d{10}$/;
    if (!phoneRegex.test(phone)) {
      setPhoneError(true);
      return; // é˜»æ­¢é€å‡º
    }
    onAdd({ name, relation, phone });
  };

  return (
    <div className="fixed inset-0 z-[80] bg-black/60 flex items-end sm:items-center justify-center p-4 animate-fade-in">
       <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
          <div className="flex justify-between items-center mb-6">
            <h3 className="font-bold text-xl text-gray-800">æ–°å¢èˆ‡ä»–å…±äº«</h3>
            <button onClick={onClose}><X size={24} className="text-gray-400"/></button>
          </div>
          
          <div className="space-y-4">
            <div>
              <label className="text-sm font-bold text-gray-600 mb-1 block">å°æ–¹å§“å</label>
              <input type="text" value={name} onChange={e=>setName(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-teal-500" placeholder="ä¾‹å¦‚ï¼šé™³å­è±ª" />
            </div>
            <div>
              <label className="text-sm font-bold text-gray-600 mb-1 block">é—œä¿‚</label>
              <select value={relation} onChange={e=>setRelation(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none">
                <option>çˆ¶è¦ª</option>
                <option>æ¯è¦ª</option>
                <option>å…’å­</option>
                <option>å¥³å…’</option>
                <option>å…„å¼Ÿ</option>
                <option>å§Šå¦¹</option>
                <option>ä¼´ä¾¶</option>
                <option>æœ‹å‹</option>
                <option>å…¶ä»–</option>
              </select>
            </div>
            <div>
              <label className="text-sm font-bold text-gray-600 mb-1 block">æ‰‹æ©Ÿè™Ÿç¢¼ (ç™¼é€é‚€è«‹ç”¨)</label>
              <input 
                type="tel" 
                value={phone} 
                onChange={e => {
                  setPhone(e.target.value);
                  if (phoneError) setPhoneError(false);
                }} 
                className={`w-full p-3 bg-gray-50 border rounded-xl focus:outline-none ${phoneError ? 'border-red-500 bg-red-50' : 'border-gray-200 focus:border-teal-500'}`} 
                placeholder="0912345678" 
                maxLength={10}
              />
              {phoneError && <p className="text-xs text-red-500 mt-1 font-bold">è«‹è¼¸å…¥æ­£ç¢ºçš„ 10 ä½æ‰‹æ©Ÿè™Ÿç¢¼</p>}
            </div>
            
            <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-100 flex items-start">
               <Info size={16} className="text-yellow-600 mt-0.5 mr-2 shrink-0"/>
               <p className="text-xs text-yellow-800">é€å‡ºå¾Œï¼Œå°æ–¹å°‡æ”¶åˆ°é‚€è«‹é€šçŸ¥ã€‚å°æ–¹æ¥å—å¾Œæ‰ç®—å…±äº«æˆåŠŸã€‚</p>
            </div>

            <button onClick={handleSubmit} className="w-full py-3.5 bg-teal-600 text-white rounded-xl font-bold shadow-lg hover:bg-teal-700 transition active:scale-95 mt-2">
              ç™¼é€é‚€è«‹
            </button>
          </div>
       </div>
    </div>
  );
};

// --- Shared User Detailed View (Full Screen Overlay) ---
const SharedUserView = ({ user, onClose, onOpenReport, showToast }) => {
  if (!user) return null;

  return (
    <div className="fixed inset-0 z-[90] bg-gray-50 flex flex-col animate-slide-up">
       {/* ç§»é™¤ 'å”¯è®€æ¨¡å¼' çš„ rightAction */}
       <TopBar 
          title={`æª¢è¦–ï¼š${user.name} (${user.relation})`} 
          onBack={onClose} 
       />
       <div className="flex-1 overflow-y-auto pb-10">
          {/* User Header Summary */}
          <div className="bg-teal-700 p-6 pb-12 rounded-b-[2.5rem] relative shadow-md">
             <div className="flex items-center space-x-4 mb-4">
                <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center text-2xl font-bold text-teal-700 shadow-lg border-2 border-teal-200">
                  {user.avatar || user.name[0]}
                </div>
                <div>
                   <h2 className="text-xl font-bold text-white">{user.name}</h2>
                   <p className="text-teal-200 text-sm">é—œä¿‚ï¼š{user.relation} | ç‹€æ…‹ï¼šæ­£å¸¸</p>
                </div>
             </div>
             {/* Key Stats Row */}
             <div className="flex justify-between gap-2 mt-2">
                <div className="bg-white/10 flex-1 p-2 rounded-lg backdrop-blur-sm text-center">
                   <p className="text-[10px] text-teal-200 mb-1">ä»Šæ—¥æ”¶ç¸®å£“</p>
                   <p className="text-white font-bold text-lg">125</p>
                </div>
                <div className="bg-white/10 flex-1 p-2 rounded-lg backdrop-blur-sm text-center">
                   <p className="text-[10px] text-teal-200 mb-1">ä»Šæ—¥è¡€ç³–</p>
                   <p className="text-white font-bold text-lg">98</p>
                </div>
                <div className="bg-white/10 flex-1 p-2 rounded-lg backdrop-blur-sm text-center">
                   <p className="text-[10px] text-teal-200 mb-1">ç¡çœ æ™‚æ•¸</p>
                   <p className="text-white font-bold text-lg">7.5</p>
                </div>
             </div>
          </div>

          <div className="px-4 -mt-8 relative z-10 space-y-4">
             {/* 1. Trends */}
             <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <SectionHeader icon={TrendingUp} title="å¥åº·æ•¸æ“šè¶¨å‹¢" />
                <div className="h-40 w-full mb-2">
                   <ResponsiveContainer>
                      <LineChart data={initialHealthData.slice(-14)}>
                         <CartesianGrid strokeDasharray="3 3" vertical={false} />
                         <XAxis dataKey="date" tick={{fontSize:10}} interval={2} />
                         <YAxis domain={[60, 160]} tick={{fontSize:10}} />
                         <Tooltip />
                         <Line type="monotone" dataKey="sys" name="æ”¶ç¸®å£“" stroke="#EF4444" strokeWidth={2} dot={false} />
                         <Line type="monotone" dataKey="dia" name="èˆ’å¼µå£“" stroke="#3B82F6" strokeWidth={2} dot={false} />
                      </LineChart>
                   </ResponsiveContainer>
                </div>
                <div className="grid grid-cols-3 gap-2 text-center text-xs text-gray-500">
                   <span className="bg-gray-50 p-1 rounded">è¡€å£“ç©©å®š</span>
                   <span className="bg-gray-50 p-1 rounded">é«”é‡æŒå¹³</span>
                   <span className="bg-gray-50 p-1 rounded">ç¡çœ æ”¹å–„</span>
                </div>
             </div>

             {/* 2. Calendars (Simplified) */}
             <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <SectionHeader icon={Calendar} title="ç”Ÿæ´»æ—¥æ›† (æœ¬é€±)" />
                <div className="flex justify-between mb-4">
                   {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map((d,i) => (
                      <div key={i} className={`flex flex-col items-center p-2 rounded-lg ${i===5 ? 'bg-teal-50 border border-teal-100' : ''}`}>
                         <span className="text-[10px] text-gray-400 mb-1">{d}</span>
                         <div className={`w-2 h-2 rounded-full ${Math.random()>0.3 ? 'bg-green-400' : 'bg-gray-300'}`}></div>
                      </div>
                   ))}
                </div>
                <div className="space-y-2">
                   <div className="flex items-center text-sm p-2 bg-gray-50 rounded">
                      <Pill size={16} className="text-blue-500 mr-3"/>
                      <span className="flex-1 text-gray-700">ç”¨è—¥é”æˆç‡</span>
                      <span className="font-bold text-blue-600">100%</span>
                   </div>
                   <div className="flex items-center text-sm p-2 bg-gray-50 rounded">
                      <Utensils size={16} className="text-green-500 mr-3"/>
                      <span className="flex-1 text-gray-700">é£²é£Ÿç´€éŒ„</span>
                      <span className="font-bold text-green-600">85%</span>
                   </div>
                </div>
             </div>

             {/* 3. Reports List */}
             <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <SectionHeader icon={FileText} title="è©³ç´°æœˆå ±" />
                <div className="divide-y divide-gray-100">
                   {reportsMock.map(report => (
                      <div key={report.id} className="py-3 flex items-center justify-between">
                         <div className="flex items-center">
                            <div className="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center mr-3">
                               <FileText size={20}/>
                            </div>
                            <div>
                               <p className="font-bold text-sm text-gray-800">{report.title}</p>
                               <p className="text-[10px] text-gray-400">è©•åˆ†: {report.score} | {report.date}</p>
                            </div>
                         </div>
                         <div className="flex space-x-2">
                            <button onClick={() => showToast('æœˆå ±å·²ä¸‹è¼‰', 'success')} className="p-2 text-gray-400 hover:text-teal-600 bg-gray-50 rounded-full">
                               <Download size={16}/>
                            </button>
                            <button onClick={() => onOpenReport(report)} className="p-2 text-white bg-teal-600 rounded-full shadow-sm text-xs font-bold px-3">
                               æŸ¥çœ‹
                            </button>
                         </div>
                      </div>
                   ))}
                </div>
             </div>

             {/* 4. Advice & Goals Summary */}
             <div className="grid grid-cols-2 gap-3 pb-6">
                <div className="bg-orange-50 p-3 rounded-xl border border-orange-100">
                   <div className="flex items-center mb-2 text-orange-800 font-bold text-sm">
                      <Target size={16} className="mr-1"/> ç›®æ¨™é”æˆ
                   </div>
                   <div className="text-2xl font-bold text-orange-600 mb-1">85%</div>
                   <p className="text-[10px] text-orange-400">æœ¬æœˆé€²åº¦è‰¯å¥½</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-xl border border-blue-100">
                   <div className="flex items-center mb-2 text-blue-800 font-bold text-sm">
                      <Sparkles size={16} className="mr-1"/> è—¥å¸«å»ºè­°
                   </div>
                   <p className="text-xs text-blue-600 leading-snug line-clamp-2">å»ºè­°å¢åŠ æ·±ç¶ è‰²è”¬èœæ”å–ï¼Œä¸¦ç¶­æŒæ¯æ—¥å¿«èµ°ã€‚</p>
                </div>
             </div>
          </div>
       </div>
    </div>
  );
}

// --- Views (Restored and Fixed) ---

const HomeView = ({ dailyEarned, handleCheckIn, hasCheckedIn, points, setActiveTab, medications, takeMedication, setShowAddMedModal, showToast, tasks, toggleTask, onNotificationClick, handleOpenSharedUser }) => (
  <div className="pb-24 animate-fade-in bg-gray-50">
    <TopBar title="å¥åº·ç¸½è¦½" showUser={true} points={points} onNotificationClick={onNotificationClick} unreadCount={3} />
    {/* é»æ“Šæ¯è¦ªå€å¡Šï¼Œç›´æ¥é–‹å•Ÿ SharedUserView */}
    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-4 py-3 flex items-center justify-between border-b border-blue-100 cursor-pointer" onClick={() => handleOpenSharedUser(initialSharedWithMe[0])}>
       <div className="flex items-center"><div className="bg-white p-1 rounded-full shadow-sm mr-3"><Users size={16} className="text-blue-600"/></div><div><p className="text-[10px] text-gray-500 font-bold mb-0.5">æ¯è¦ª (90å¤©æ”¹å–„è¨ˆç•«)</p><p className="text-xs text-gray-800 font-bold">è¡€å£“æ­£å¸¸ï¼Œå°šæœªæœè—¥ã€‚</p></div></div><ChevronRight size={16} className="text-blue-400"/>
    </div>
    <div className="bg-white p-4 mb-2 shadow-sm">
       <div className="flex justify-between items-center mb-2"><div><h2 className="font-bold text-gray-800 flex items-center"><Award className="text-yellow-500 mr-2" size={20}/><span className="text-sm">ä»Šæ—¥å·²ç²ï¼š{dailyEarned}/{MAX_DAILY_POINTS}</span></h2><div className="w-24 bg-gray-100 rounded-full h-1.5 mt-1"><div className="h-full rounded-full transition-all duration-500" style={{ width: `${(dailyEarned/MAX_DAILY_POINTS)*100}%`, backgroundColor: ACCENT_COLOR }}></div></div></div><button onClick={handleCheckIn} disabled={hasCheckedIn} className={`text-xs px-3 py-1.5 rounded-full font-bold border transition-all active:scale-95 ${hasCheckedIn ? 'bg-gray-100 text-gray-400 border-gray-200' : 'bg-teal-50 text-teal-700 border-teal-200 hover:bg-teal-100'}`}>{hasCheckedIn ? 'ä»Šæ—¥å·²ç°½åˆ°' : 'æ¯æ—¥ç°½åˆ° (+10)'}</button></div>
       <div className="grid grid-cols-2 gap-3 mt-3"><button onClick={() => setActiveTab('coupons')} className="py-2 border rounded-lg text-sm text-gray-600 flex items-center justify-center hover:bg-gray-50 transition"><Ticket size={16} className="mr-1 text-orange-500"/> å…Œæ›æŠ˜åƒ¹åˆ¸</button><button onClick={() => setActiveTab('gifts')} className="py-2 border rounded-lg text-sm text-gray-600 flex items-center justify-center hover:bg-gray-50 transition"><Gift size={16} className="mr-1 text-red-500"/> å…Œæ›å°ç¦®å“</button></div>
    </div>
    <div className="mx-4 mt-2"><SectionHeader icon={Pill} title="ä»Šæ—¥ç”¨è—¥æé†’" actionText="ç·¨è¼¯ / æ–°å¢" onAction={() => setShowAddMedModal(true)} /><div className="bg-white rounded-xl shadow-sm border-l-4 border-blue-500 divide-y divide-gray-50">{medications.map(med => { const daysLeft = Math.floor(med.stock / (med.dosage * 1)); const isLowStock = daysLeft < 5; return (<div key={med.id} className="p-4 flex flex-col space-y-3"><div className="flex justify-between items-start"><div><p className="font-bold text-gray-800 text-lg">{med.name}</p><p className="text-xs text-gray-500">{med.time} â€¢ {med.frequency} â€¢ {med.dosage} {med.unit}</p></div><div className="text-right">{isLowStock ? <span className="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded">å‰© {daysLeft} å¤©ä»½</span> : <span className="text-xs font-bold text-teal-600 bg-teal-50 px-2 py-1 rounded">åº«å­˜å……è¶³</span>}</div></div><div className="flex items-center space-x-2"><button onClick={() => takeMedication(med.id)} disabled={med.taken} className={`flex-1 py-2 rounded-lg text-sm font-bold flex items-center justify-center transition active:scale-95 ${med.taken ? 'bg-gray-100 text-gray-400 cursor-default' : 'bg-blue-600 text-white shadow-md'}`}>{med.taken ? <><CheckCircle size={16} className="mr-1"/> å·²æœç”¨</> : 'ç¢ºèªæœç”¨'}</button>{isLowStock && (<button onClick={() => showToast('å·²åŠ å…¥æ‰‹æ©Ÿè¡Œäº‹æ›†ï¼šé ˜è—¥æé†’', 'info')} className="flex-1 py-2 border border-red-200 text-red-600 bg-red-50 rounded-lg text-sm font-bold flex items-center justify-center active:scale-95"><Calendar size={16} className="mr-1"/> é ç´„é ˜è—¥</button>)}</div></div>);})}{medications.length === 0 && <p className="p-4 text-center text-gray-400 text-sm">ç›®å‰æ²’æœ‰è¨­å®šç”¨è—¥æé†’</p>}</div></div>
    <div className="mx-4 mb-4"><SectionHeader icon={CheckSquare} title="ä»Šæ—¥å¥åº·ä»»å‹™" /><div className="bg-white rounded-xl shadow-sm p-4"><div className="flex justify-between items-center mb-3"><span className="text-sm font-bold text-gray-700">å®Œæˆåº¦</span><span className="text-xs text-gray-400">{tasks.filter(t=>t.completed).length}/{tasks.length}</span></div><div className="w-full bg-gray-100 rounded-full h-2 mb-4"><div className="bg-teal-500 h-2 rounded-full transition-all duration-500" style={{width: `${(tasks.filter(t=>t.completed).length/tasks.length)*100}%`}}></div></div><div className="space-y-2">{tasks.map(task => (<div key={task.id} onClick={() => toggleTask(task.id)} className={`p-3 rounded-lg border flex items-center justify-between transition cursor-pointer ${task.completed ? 'bg-gray-50 border-gray-100 opacity-60' : 'bg-white border-gray-200 hover:shadow-md'}`}><div className="flex items-center">{task.completed ? <CheckCircle className="text-teal-600 mr-3" size={20} /> : <Circle className="text-gray-300 mr-3" size={20} />}<span className="text-sm text-gray-800">{task.text}</span></div>{!task.completed && <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">+{task.points}</span>}</div>))}</div></div></div>
  </div>
);

const EduView = ({ setShowChat, showToast, points, setPoints, onNotificationClick, favorites, setFavorites }) => {
  const [quizStatus, setQuizStatus] = useState('idle');
  const [searchTerm, setSearchTerm] = useState('');
  const filteredArticles = healthArticles.filter(article => article.title.toLowerCase().includes(searchTerm.toLowerCase()) || article.tag.toLowerCase().includes(searchTerm.toLowerCase()));
  const handleQuizAnswer = (isCorrect) => {
    if (quizStatus === 'correct') return;
    if (isCorrect) { setQuizStatus('correct'); setPoints(p => p + 15); showToast('ğŸ‰ ç­”å°äº†ï¼æ­å–œç²å¾— 15 é»ï¼', 'success'); } 
    else { setQuizStatus('wrong'); showToast('ç­”éŒ¯å›‰ï¼Œå†è©¦ä¸€æ¬¡çœ‹çœ‹ï¼', 'error'); }
  };

  const toggleFavorite = (article) => {
    const exists = favorites.find(f => f.id === article.id);
    if (exists) {
      setFavorites(favorites.filter(f => f.id !== article.id));
      showToast('å·²å–æ¶ˆæ”¶è—', 'info');
    } else {
      setFavorites([...favorites, { ...article, dateAdded: TODAY_DATE }]);
      showToast('å·²åŠ å…¥æ”¶è—', 'success');
    }
  };

  return (
    <div className="pb-24 animate-fade-in bg-gray-50 h-full flex flex-col">
      <TopBar title="æ™ºæ…§è¡›æ•™äº’å‹•" points={points} onNotificationClick={onNotificationClick} unreadCount={3} />
      <div className="p-4 bg-white shadow-sm space-y-3">
         <div className="relative"><input type="text" placeholder="è«‹è¼¸å…¥é—œéµå­—æœå°‹ (ä¾‹å¦‚ï¼šBç¾¤ã€è‘‰é»ƒç´ )..." className="w-full bg-gray-100 rounded-full py-2 px-4 pl-10 text-sm focus:outline-none focus:ring-1 focus:ring-teal-500" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /><Search className="absolute left-3 top-2.5 text-gray-400" size={16} /></div>
         <div className={`border rounded-lg p-4 transition-all duration-500 ${quizStatus === 'correct' ? 'bg-green-50 border-green-200' : 'bg-teal-50 border-teal-100'}`}>
            <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-teal-700 bg-white px-2 py-0.5 rounded border border-teal-200">æœ¬é€±å•ç­”</span><span className="text-xs text-teal-600 font-bold">+15 é»</span></div>
            <p className="text-sm font-bold text-gray-800 mb-3">æœç”¨é™è¡€å£“è—¥ç‰©å¾Œï¼Œæ˜¯å¦å¯ä»¥ç«‹å³é£²ç”¨è‘¡è„æŸšæ±ï¼Ÿ</p>
            {quizStatus === 'correct' ? (<div className="flex items-center text-green-600 font-bold justify-center py-2 bg-white rounded-lg shadow-sm"><ThumbsUp size={18} className="mr-2"/> ç­”å°äº†ï¼å·²ç²å¾—çå‹µ</div>) : (
               <div className="flex gap-2">
                  <button onClick={() => handleQuizAnswer(false)} className={`flex-1 py-2 bg-white border border-gray-200 rounded text-xs text-gray-600 font-medium transition active:scale-95 ${quizStatus === 'wrong' ? 'border-red-400 text-red-500 bg-red-50' : ''}`}>å¯ä»¥</button>
                  <button onClick={() => handleQuizAnswer(true)} className="flex-1 py-2 bg-white border border-gray-200 rounded text-xs text-gray-600 font-medium transition active:scale-95">ä¸å¯ä»¥</button>
               </div>
            )}
         </div>
      </div>
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
         <h3 className="font-bold text-gray-700 text-sm">ç²¾é¸è¡›æ•™æ–‡ç« </h3>
         {filteredArticles.length > 0 ? filteredArticles.map((article) => {
            const isFav = favorites.some(f => f.id === article.id);
            return (
            <div key={article.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition">
               <div className="flex justify-between items-start mb-2"><span className="text-[10px] px-2 py-0.5 bg-teal-50 text-teal-700 rounded border border-teal-100">{article.tag}</span><div className="flex space-x-3 text-gray-400"><button onClick={()=>toggleFavorite(article)} className={isFav ? "text-red-500" : "hover:text-red-500"}><Heart size={16} fill={isFav ? "currentColor" : "none"}/></button><button onClick={()=>showToast('åƒ…åˆ†äº«æª¢è¦–æ¬Šé™çµ¦å®¶äºº')} className="hover:text-blue-500"><Share2 size={16}/></button></div></div>
               <h4 className="font-bold text-gray-800 text-lg mb-2">{article.title}</h4>
               <button onClick={() => window.open(article.url, '_blank')} className="w-full py-2.5 bg-white text-teal-700 text-sm rounded-lg font-bold border border-teal-200 flex items-center justify-center hover:bg-teal-50 transition active:scale-95"><ExternalLink size={14} className="mr-2"/> æŸ¥çœ‹å®Œæ•´è¡›æ•™æ–‡ç« </button>
            </div>
         )}) : <div className="text-center text-gray-400 py-10">æ‰¾ä¸åˆ°ç›¸é—œæ–‡ç« </div>}
      </div>
      <div className="p-4 bg-white border-t border-gray-200"><button onClick={()=>setShowChat(true)} className="w-full py-3 rounded-full flex items-center justify-center text-white shadow-lg transition active:scale-[0.98]" style={{backgroundColor: BRAND_COLOR}}><MessageCircle className="mr-2" size={20} /> é–‹å•Ÿ AI è—¥å¸«è«®è©¢</button></div>
    </div>
  );
};

const HealthView = ({ points, showToast, subTab, setSubTab, medications, onNotificationClick, onViewSimpleReport, healthRecords, onUpdateBP, onUpdateSugar, onUpdateWeight, onUpdateSleep, onSaveDiet, onSaveExercise }) => {
  if (subTab === 'bp') return <BloodPressureView onBack={()=>setSubTab(null)} onSave={onUpdateBP} healthData={healthRecords} points={points} />;
  if (subTab === 'sugar') return <BloodSugarView onBack={()=>setSubTab(null)} onSave={onUpdateSugar} healthData={healthRecords} points={points} />;
  if (subTab === 'weight') return <WeightView onBack={()=>setSubTab(null)} onSave={onUpdateWeight} healthData={healthRecords} points={points} />;
  if (subTab === 'diet') return <DietView onBack={()=>setSubTab(null)} onSave={onSaveDiet} points={points} />;
  if (subTab === 'exercise') return <ExerciseView onBack={()=>setSubTab(null)} onSave={onSaveExercise} points={points} />;
  if (subTab === 'med') return <MedicationRecordView onBack={()=>setSubTab(null)} medications={medications} points={points} />;
  if (subTab === 'sleep') return <SleepView onBack={()=>setSubTab(null)} onSave={onUpdateSleep} healthData={healthRecords} points={points} />;
  
  return (
    <div className="pb-24 animate-fade-in bg-gray-50">
      <TopBar title="å¥åº·ç´€éŒ„èˆ‡è¿½è¹¤" points={points} onNotificationClick={onNotificationClick} unreadCount={3} />
      <div className="p-4">
         <h3 className="font-bold text-gray-700 mb-3">æ–°å¢ç´€éŒ„ & æŸ¥çœ‹è¶¨å‹¢</h3>
         <div className="grid grid-cols-4 gap-3">
            {[{ icon: Activity, label: 'è¡€å£“', id: 'bp', color: 'bg-red-50 text-red-600' }, 
              { icon: FileText, label: 'è¡€ç³–', id: 'sugar', color: 'bg-blue-50 text-blue-600' }, 
              { icon: Users, label: 'é«”é‡', id: 'weight', color: 'bg-yellow-50 text-yellow-600' }, 
              { icon: Utensils, label: 'é£²é£Ÿ', id: 'diet', color: 'bg-green-50 text-green-600' }, 
              { icon: Dumbbell, label: 'é‹å‹•', id: 'exercise', color: 'bg-orange-50 text-orange-600' }, 
              { icon: Pill, label: 'ç”¨è—¥', id: 'med', color: 'bg-purple-50 text-purple-600' }, 
              { icon: Moon, label: 'ç¡çœ ', id: 'sleep', color: 'bg-indigo-50 text-indigo-600' }, 
              { icon: Plus, label: 'å…¶ä»–', id: 'other', color: 'bg-gray-50 text-gray-600' }
             ].map((item, idx) => (
               <button key={idx} onClick={() => item.id === 'other' ? showToast('æ­¤åŠŸèƒ½é–‹ç™¼ä¸­') : setSubTab(item.id)} className="flex flex-col items-center p-3 rounded-xl bg-white border border-gray-100 shadow-sm active:scale-95 transition"><div className={`w-12 h-12 rounded-2xl flex items-center justify-center mb-1 ${item.color}`}><item.icon size={22} /></div><span className="text-xs text-gray-600 font-bold">{item.label}</span></button>
            ))}
         </div>
      </div>
      <div className="mx-4 mb-4">
          <SectionHeader icon={FileText} title="å ±å‘Šä¸­å¿ƒ" />
          {/* é¡¯ç¤ºæ‰€æœ‰æœˆå ± */}
          <div className="bg-white rounded-xl shadow-sm divide-y divide-gray-100">
             {reportsMock.map(report => (
                <div key={report.id} onClick={()=>onViewSimpleReport(report)} className="p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition"><div className="flex items-center"><div className="w-10 h-10 bg-red-100 text-red-500 rounded-lg flex items-center justify-center mr-3"><FileText size={20}/></div><div><p className="font-bold text-sm text-gray-800">{report.title}</p><p className="text-xs text-gray-400">{report.date} ç”Ÿæˆ</p></div></div><ChevronRight size={18} className="text-gray-300"/></div>
             ))}
          </div>
      </div>
    </div>
  );
};

const PlanView = ({ planMode, setPlanMode, showToast, points, onNotificationClick, setShowBarcode, onClaimCashback, hasClaimedCashback }) => {
  const [selectedSupplement, setSelectedSupplement] = useState(null);
  const [showCallConfirm, setShowCallConfirm] = useState(false);
  const supplementsData = [
    { id: 's1', name: 'æ·±æµ·é­šæ²¹ (Omega-3)', quantity: 'x 1 ç“¶', desc: 'é«˜æ¿ƒåº¦ Omega-3ï¼Œæœ‰äº›å¾®æŠ—å‡è¡€ä½œç”¨ï¼Œæœ‰åŠ©æ–¼å¿ƒè¡€ç®¡å¥åº·ã€‚', freq: 'æ¯æ—¥é£¯å¾Œ 1 é¡†', target: 'é™ä½ä¸‰é…¸ç”˜æ²¹è„‚ã€æŠ—ç™¼ç‚' },
    { id: 's2', name: 'ç´è±†ç´…éº´', quantity: 'x 1 ç›’', desc: 'å« Monacolin Kï¼Œæœ‰åŠ©æ–¼ç¶­æŒè†½å›ºé†‡æ­£å¸¸ã€‚', freq: 'æ¯æ—¥ç¡å‰ 1 é¡†', target: 'èª¿ç¯€è¡€è„‚ã€ä¿ƒé€²ä»£è¬' }
  ];

  return (
    <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
      <TopBar title="æ–¹æ¡ˆå°ˆå€" points={points} onNotificationClick={onNotificationClick} unreadCount={3} />
      <div className="bg-gray-800 p-3 overflow-x-auto whitespace-nowrap flex items-center"><span className="text-white text-xs mr-2 font-bold">ã€æ¨¡å¼åˆ‡æ›ã€‘ï¼š</span><div className="flex space-x-2">{[{id: 'improve', label: '90å¤©æ”¹å–„'}, {id: 'challenge', label: '90å¤©æŒ‘æˆ°'}].map(m => (<button key={m.id} onClick={()=>setPlanMode(m.id)} className={`px-3 py-1 rounded-full text-xs font-bold transition ${planMode === m.id ? 'bg-teal-500 text-white' : 'bg-gray-700 text-gray-300'}`}>{m.label}</button>))}</div></div>
      
      {planMode === 'improve' && (
        <div className="p-4 space-y-4">
          
          {/* 1. 90å¤©é€²åº¦æ¢ (Timeline) */}
          <div className="bg-teal-800 text-white p-5 rounded-2xl shadow-lg relative overflow-hidden">
            <div className="relative z-10">
              <div className="flex justify-between items-start mb-4">
                <h2 className="font-bold text-lg">90å¤© å¥åº·åŒè¡Œæ”¹å–„è¨ˆç•«</h2>
                <span className="px-2 py-0.5 bg-white/20 rounded text-[10px]">Day 35 / 90</span>
              </div>
              
              <div className="relative pt-4 pb-6">
                {/* Progress Line */}
                <div className="w-full bg-black/20 rounded-full h-1.5 absolute top-5"></div>
                <div className="absolute top-5 h-1.5 bg-teal-300 rounded-full" style={{width: '35%'}}></div>
                
                {/* Nodes */}
                <div className="flex justify-between relative text-[10px] text-teal-200 font-bold">
                   <div className="flex flex-col items-center">
                      <div className="w-3 h-3 bg-teal-300 rounded-full mb-2 border-2 border-teal-800 relative z-10"></div>
                      <span>Start</span>
                   </div>
                   <div className="flex flex-col items-center">
                      <div className="w-3 h-3 bg-white/30 rounded-full mb-2 relative z-10"></div>
                      <span>Day 45 (æœŸä¸­)</span>
                   </div>
                   <div className="flex flex-col items-center">
                      <div className="w-3 h-3 bg-white/30 rounded-full mb-2 relative z-10"></div>
                      <span>Day 90 (çµç®—)</span>
                   </div>
                </div>
              </div>
            </div>
          </div>

          {/* 2. æ ¸å¿ƒå¥åº·ç›®æ¨™å¡ (Core Goal Card) */}
          <div className="bg-gradient-to-r from-orange-100 to-amber-50 p-4 rounded-xl border border-orange-200 shadow-sm relative overflow-hidden">
             <div className="flex justify-between items-start mb-2 relative z-10">
                <h3 className="font-bold text-orange-900 flex items-center">
                   <Target size={18} className="mr-2"/> æ ¸å¿ƒå¥åº·ç›®æ¨™
                </h3>
                <span className="text-xs bg-white text-orange-600 px-2 py-0.5 rounded font-bold border border-orange-200">é€²è¡Œä¸­</span>
             </div>
             <p className="text-lg font-bold text-gray-800 mb-2 relative z-10">ç›®æ¨™ï¼š90å¤©å…§æ”¶ç¸®å£“é™ä½ 5 mmHg</p>
             <div className="bg-white/60 p-3 rounded-lg flex items-start relative z-10">
                <Sparkles size={16} className="text-yellow-500 mr-2 shrink-0 mt-0.5"/>
                <p className="text-xs text-gray-700 font-bold">AI è©•èªï¼šç›®å‰å·²é”æˆ 30%ï¼Œé€²åº¦è‰¯å¥½ï¼è«‹ç¹¼çºŒä¿æŒç›®å‰çš„é‹å‹•é »ç‡ã€‚</p>
             </div>
             <Target size={100} className="absolute -right-4 -bottom-4 text-orange-200 opacity-30 rotate-12"/>
          </div>

          {/* 4. è—¥å¸«è«®è©¢ */}
          <div className="bg-white p-4 rounded-xl shadow-sm">
            <SectionHeader icon={User} title="å°ˆå±¬è—¥å¸«è«®è©¢" />
            <div className="flex items-center mb-4 bg-gray-50 p-3 rounded-lg">
              <div className="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mr-3 border-2 border-white shadow-sm">
                <User size={24} className="text-gray-500"/>
              </div>
              <div className="flex-1">
                <p className="font-bold text-gray-800">é™³è—¥å¸« (èºç…å—é–€åº—)</p>
                <p className="text-xs text-teal-600">ç·šä¸Š</p>
              </div>
              <button onClick={()=>setShowCallConfirm(true)} className="p-2 bg-teal-50 text-teal-600 rounded-full"><Phone size={18}/></button>
            </div>
            <div className="grid grid-cols-2 gap-3 mb-2">
              <div className="flex flex-col">
                 <ActionButton icon={Calendar} label="é ç´„è«®è©¢" onClick={()=>showToast('å·²é ç´„è«®è©¢ä¸¦æ–°å¢è‡³è¡Œäº‹æ›†', 'success')} />
                 <p className="text-[10px] text-gray-400 mt-1 text-center">è· Day 45 æœŸä¸­è«®è©¢å‰© 10 å¤©ï¼Œå¯æå‰é ç´„</p>
              </div>
              <ActionButton icon={FileText} label="èˆ‡è—¥å¸«åˆ†äº«å ±å‘Š" onClick={()=>showToast('å·²èˆ‡è—¥å¸«åˆ†äº«', 'success')} />
            </div>
          </div>

          {/* 5. ä¿å¥å“é…ç½® */}
          <div className="bg-white p-4 rounded-xl shadow-sm">
            <SectionHeader icon={Pill} title="æœ¬å­£ä¿å¥å“é…ç½®" />
            <div className="space-y-2 mb-4">
              {supplementsData.map(supp => (
                <div key={supp.id} onClick={() => setSelectedSupplement(supp)} className="flex justify-between items-center text-sm text-gray-600 border-b border-gray-50 pb-2 cursor-pointer hover:bg-gray-50 p-2 rounded transition">
                  <div className="flex items-center">
                    <Info size={14} className="text-teal-400 mr-2"/>
                    <span className="font-medium text-gray-700">{supp.name}</span>
                  </div>
                  <span>{supp.quantity}</span>
                </div>
              ))}
            </div>
            <button onClick={() => setShowBarcode({ title: 'æœ¬å­£ä¿å¥å“é ˜å–', desc: 'è«‹å‡ºç¤ºæ­¤æ¢ç¢¼çµ¦è—¥å¸«æ ¸éŠ·', uid: 'MED-PICKUP-001', type: 'coupon' })} className="w-full py-2.5 border border-teal-600 text-teal-600 rounded-lg text-sm font-bold flex items-center justify-center transition active:bg-teal-50">
               <MapPin size={16} className="mr-2"/> è‡³é–€å¸‚é ˜å– (å‡ºç¤ºæ¢ç¢¼)
            </button>
            <div className="mt-2 text-xs text-orange-500 flex items-center">
              <AlertCircle size={12} className="mr-1"/> æé†’ï¼šé­šæ²¹å‰©é¤˜ 5 å¤©ä»½é‡ï¼Œå»ºè­°æå‰é ˜å–ã€‚
            </div>
          </div>
        </div>
      )}

      {planMode === 'challenge' && (
        <div className="p-4 space-y-4">
          
          {/* 1. 90å¤©é€²åº¦æ¢ (Timeline) - èˆ‡æ”¹å–„è¨ˆç•«ä¸€è‡´ */}
          <div className="bg-teal-800 text-white p-5 rounded-2xl shadow-lg relative overflow-hidden">
            <div className="relative z-10">
              <div className="flex justify-between items-start mb-4">
                <h2 className="font-bold text-lg">90å¤© é€†è½‰æŒ‘æˆ°è³½</h2>
                <span className="px-2 py-0.5 bg-white/20 rounded text-[10px]">Day 75 / 90</span>
              </div>
              
              <div className="relative pt-4 pb-6">
                {/* Progress Line */}
                <div className="w-full bg-black/20 rounded-full h-1.5 absolute top-5"></div>
                <div className="absolute top-5 h-1.5 bg-teal-300 rounded-full" style={{width: '83%'}}></div>
                
                {/* Nodes */}
                <div className="flex justify-between relative text-[10px] text-teal-200 font-bold">
                   <div className="flex flex-col items-center">
                      <div className="w-3 h-3 bg-teal-300 rounded-full mb-2 border-2 border-teal-800 relative z-10"></div>
                      <span>Start</span>
                   </div>
                   <div className="flex flex-col items-center">
                      <div className="w-3 h-3 bg-teal-300 rounded-full mb-2 border-2 border-teal-800 relative z-10"></div>
                      <span>Day 45 (æœŸä¸­)</span>
                   </div>
                   <div className="flex flex-col items-center">
                      <div className="w-3 h-3 bg-white/30 rounded-full mb-2 relative z-10"></div>
                      <span>Day 90 (çµç®—)</span>
                   </div>
                </div>
              </div>
            </div>
          </div>

          {/* 2. Challenge Card - Updated (Bigger & Clearer) */}
          <div className="bg-gradient-to-br from-orange-500 to-red-600 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
            <div className="relative z-10">
              <h2 className="font-bold text-lg flex items-center mb-6"><TrendingUp className="mr-2"/> é€†è½‰æŒ‘æˆ°è³½ç›®æ¨™</h2>
              
              <div className="grid grid-cols-2 gap-4 mb-6">
                 {/* Target Box */}
                 <div className="bg-white/10 rounded-2xl p-4 backdrop-blur-md border border-white/20 flex flex-col items-center justify-center shadow-inner min-h-[120px]">
                    <span className="text-orange-100 text-xs font-bold mb-2">æŒ‘æˆ°ç›®æ¨™ (æ”¶ç¸®å£“)</span>
                    <div className="flex items-baseline">
                      <span className="font-black text-5xl drop-shadow-sm tracking-tight">{'<'}130</span>
                      <span className="text-sm ml-1 font-bold text-orange-100">mmHg</span>
                    </div>
                 </div>

                 {/* Countdown Box */}
                 <div className="bg-white/10 rounded-2xl p-4 backdrop-blur-md border border-white/20 flex flex-col items-center justify-center shadow-inner min-h-[120px]">
                    <span className="text-orange-100 text-xs font-bold mb-2">æœŸé™å€’æ•¸</span>
                    <div className="flex items-baseline">
                      <span className="font-black text-5xl text-yellow-300 drop-shadow-sm tracking-tight">15</span>
                      <span className="text-sm ml-1 font-bold text-yellow-300">å¤©</span>
                    </div>
                    <span className="text-[10px] text-orange-200 mt-1 bg-black/10 px-2 py-0.5 rounded-full">2026/01/01 çµç®—</span>
                 </div>
              </div>

              <div className="flex justify-between items-end bg-black/10 p-3 rounded-xl border border-white/10">
                <div>
                  <p className="text-xs text-orange-200 mb-0.5">é”æ¨™åŸºæœ¬å›é¥‹é‡‘</p>
                  <p className="text-2xl font-bold tracking-wide">NT$ 1,000</p>
                </div>
              </div>
            </div>
            {/* è£é£¾èƒŒæ™¯ */}
            <div className="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
            <div className="absolute bottom-0 left-0 w-40 h-40 bg-yellow-500/20 rounded-full blur-3xl -ml-10 -mb-10"></div>
          </div>

          {/* 3. ä¿å¥å“é…ç½® (Supplements) - èˆ‡æ”¹å–„è¨ˆç•«ä¸€è‡´ */}
          <div className="bg-white p-4 rounded-xl shadow-sm">
            <SectionHeader icon={Pill} title="æœ¬å­£ä¿å¥å“é…ç½®" />
            <div className="space-y-2 mb-4">
              {supplementsData.map(supp => (
                <div key={supp.id} onClick={() => setSelectedSupplement(supp)} className="flex justify-between items-center text-sm text-gray-600 border-b border-gray-50 pb-2 cursor-pointer hover:bg-gray-50 p-2 rounded transition">
                  <div className="flex items-center">
                    <Info size={14} className="text-teal-400 mr-2"/>
                    <span className="font-medium text-gray-700">{supp.name}</span>
                  </div>
                  <span>{supp.quantity}</span>
                </div>
              ))}
            </div>
            <button onClick={() => setShowBarcode({ title: 'æœ¬å­£ä¿å¥å“é ˜å–', desc: 'è«‹å‡ºç¤ºæ­¤æ¢ç¢¼çµ¦è—¥å¸«æ ¸éŠ·', uid: 'MED-PICKUP-001', type: 'coupon' })} className="w-full py-2.5 border border-teal-600 text-teal-600 rounded-lg text-sm font-bold flex items-center justify-center transition active:bg-teal-50">
               <MapPin size={16} className="mr-2"/> è‡³é–€å¸‚é ˜å– (å‡ºç¤ºæ¢ç¢¼)
            </button>
            <div className="mt-2 text-xs text-orange-500 flex items-center">
              <AlertCircle size={12} className="mr-1"/> æé†’ï¼šé­šæ²¹å‰©é¤˜ 5 å¤©ä»½é‡ï¼Œå»ºè­°æå‰é ˜å–ã€‚
            </div>
          </div>

          {/* 4. æˆæœé©—æ”¶ (Results Acceptance) */}
          <div className="bg-white p-4 rounded-xl shadow-sm">
             <h3 className="font-bold text-gray-700 mb-2 flex items-center"><Award size={20} className="text-orange-500 mr-2"/>æˆæœé©—æ”¶</h3>
             <div className="flex gap-2">
                <button 
                  onClick={onClaimCashback} 
                  disabled={hasClaimedCashback} 
                  className={`flex-1 py-3 border rounded-lg text-sm font-bold flex items-center justify-center transition ${hasClaimedCashback ? 'bg-gray-100 border-gray-200 text-gray-400' : 'border-orange-200 text-orange-600 hover:bg-orange-50'}`}
                >
                  {hasClaimedCashback ? <><CheckCircle size={16} className="mr-2"/> å·²é ˜å–</> : <><Coins size={16} className="mr-2"/> é ˜å–å›é¥‹é‡‘</>}
                </button>
                <button onClick={()=>showToast('å·²ç‚ºæ‚¨é ç´„å ±å')} className="flex-1 py-3 bg-teal-50 text-teal-700 rounded-lg text-sm font-bold hover:bg-teal-100 transition flex items-center justify-center">
                  <FileText size={16} className="mr-2"/> å ±åä¸‹ä¸€å­£
                </button>
             </div>
          </div>
        </div>
      )}

      {/* Supplement Modal */}
      <SupplementModal item={selectedSupplement} onClose={() => setSelectedSupplement(null)} />
      
      {/* Phone Confirmation Modal */}
      {showCallConfirm && (
        <div className="fixed inset-0 z-[80] bg-black/60 flex items-center justify-center p-4 animate-fade-in">
           <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl relative">
              <h3 className="text-xl font-bold text-gray-800 mb-4 text-center">æ˜¯å¦æ’¥æ‰“è—¥å¸«è«®è©¢é›»è©±ï¼Ÿ</h3>
              <div className="flex gap-3">
                 <button onClick={() => setShowCallConfirm(false)} className="flex-1 py-3 border border-gray-300 text-gray-600 rounded-xl font-bold hover:bg-gray-50 transition">
                   å–æ¶ˆ
                 </button>
                 <button onClick={() => { setShowCallConfirm(false); showToast('æ­£åœ¨æ’¥æ‰“é›»è©±', 'success'); }} className="flex-1 py-3 bg-teal-600 text-white rounded-xl font-bold shadow-md hover:bg-teal-700 transition flex items-center justify-center">
                   <PhoneCall size={18} className="mr-2"/> æ’¥æ‰“
                 </button>
              </div>
           </div>
        </div>
      )}
    </div>
  );
};

const RedeemView = ({ type, points, setActiveTab, setShowMyCoupons, handleRedeem, myItems, onNotificationClick }) => {
  const items = type === 'coupon' ? couponsMock : giftsMock;
  const themeColor = type === 'coupon' ? 'teal' : 'orange';
  const bgColor = type === 'coupon' ? 'bg-teal-50 border-teal-100' : 'bg-orange-50 border-orange-100';
  const textColor = type === 'coupon' ? 'text-teal-700' : 'text-orange-700';
  const btnColor = type === 'coupon' ? 'bg-teal-600' : 'bg-orange-500';

  return (
    <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
       <TopBar title={type === 'coupon' ? "æŠ˜åƒ¹åˆ¸å…Œæ›" : "å°ç¦®å“å…Œæ›"} onBack={() => setActiveTab('home')} points={points} onNotificationClick={onNotificationClick} unreadCount={3} rightAction={<button onClick={() => setShowMyCoupons(true)} className="flex items-center bg-white/20 px-2 py-1 rounded text-xs text-white transition active:scale-95"><Wallet size={14} className="mr-1"/> æˆ‘çš„ç¥¨åˆ¸</button>} />
       <div className="p-4 space-y-4">
          <div className={`${bgColor} p-4 rounded-xl border flex justify-between items-center`}><div><p className="text-xs text-gray-500">ç›®å‰æŒæœ‰é»æ•¸</p><p className={`text-2xl font-bold ${textColor}`}>{points}</p></div>{type === 'coupon' ? <Ticket className="text-teal-300" size={40} /> : <Gift className="text-orange-300" size={40} />}</div>
          <h3 className="font-bold text-gray-700">å¯å…Œæ›é …ç›®</h3>
          <div className="space-y-3">{items.map(item => { const count = myItems.filter(i => i.id === item.id).length; return (<div key={item.id} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex items-center p-4">{item.icon && <div className="w-12 h-12 bg-gray-50 rounded-lg flex items-center justify-center text-2xl mr-4">{item.icon}</div>}<div className="flex-1"><div className="flex items-center"><h4 className="font-bold text-gray-800">{item.title}</h4>{count > 0 && <span className="ml-2 text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded border border-gray-200">æŒæœ‰ {count}</span>}</div><p className="text-xs text-gray-500">{item.desc}</p><p className={`text-sm font-bold mt-1 ${textColor}`}>{item.cost} é»</p></div><button onClick={() => handleRedeem(item)} className={`px-4 py-2 rounded-lg text-xs font-bold shadow-sm transition active:scale-95 text-white ${points >= item.cost ? btnColor : 'bg-gray-300'}`}>å…Œæ›</button></div>)})}</div>
       </div>
    </div>
  );
};

const MyCouponsView = ({ myItems, setShowMyCoupons, setShowBarcode, setActiveTab, points, onNotificationClick }) => (
  <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
     <TopBar title="æˆ‘çš„ç¥¨åˆ¸å¤¾" onBack={() => setShowMyCoupons(false)} points={points} onNotificationClick={onNotificationClick} unreadCount={3} />
     <div className="p-4 space-y-4">
        {myItems.length === 0 ? (<div className="flex flex-col items-center justify-center py-20 text-gray-400"><ShoppingBag size={48} className="mb-4 opacity-20" /><p>æ‚¨å°šæœªå…Œæ›ä»»ä½•å•†å“</p><button onClick={()=>{setShowMyCoupons(false); setActiveTab('coupons')}} className="mt-4 text-teal-600 text-sm font-bold underline">å»å…Œæ›ä¸­å¿ƒé€›é€›</button></div>) : (myItems.map(item => (<div key={item.uid} onClick={() => setShowBarcode(item)} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden relative cursor-pointer hover:shadow-md transition active:scale-[0.99]"><div className={`absolute left-0 top-0 bottom-0 w-2 ${item.type === 'coupon' ? 'bg-orange-400' : 'bg-blue-400'}`}></div><div className="p-4 pl-6"><div className="flex justify-between items-start"><div><span className={`text-[10px] px-2 py-0.5 rounded text-white mb-1 inline-block ${item.type === 'coupon' ? 'bg-orange-400' : 'bg-blue-400'}`}>{item.type === 'coupon' ? 'æŠ˜åƒ¹åˆ¸' : 'ç¦®å“åˆ¸'}</span><h4 className="font-bold text-lg text-gray-800">{item.title}</h4><p className="text-xs text-gray-500">{item.desc}</p></div><ScanLine className="text-gray-300" size={24} /></div><div className="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center"><span className="text-xs text-gray-400">å…Œæ›æ—¥æœŸï¼š{item.redeemDate}</span><span className="text-xs font-bold text-teal-600 bg-teal-50 px-2 py-1 rounded flex items-center"><Tag size={12} className="mr-1"/> é»æ“Šé¡¯ç¤ºæ ¸éŠ·æ¢ç¢¼</span></div></div></div>)))}
     </div>
  </div>
);

const FavoritesView = ({ onBack, points, favorites }) => (
  <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
    <TopBar title="æˆ‘çš„æ”¶è—" onBack={onBack} points={points} />
    <div className="p-4 space-y-4">
      {favorites.length === 0 ? (
        <div className="flex flex-col items-center justify-center py-20 text-gray-400">
          <Heart size={48} className="mb-4 opacity-20" />
          <p>æ‚¨å°šæœªæ”¶è—ä»»ä½•æ–‡ç« </p>
        </div>
      ) : (
        favorites.map(article => (
          <div key={article.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-start cursor-pointer hover:shadow-md transition" onClick={() => window.open(article.url, '_blank')}>
            <div className="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center mr-4 shrink-0 text-gray-400">
               <FileText size={24}/>
            </div>
            <div className="flex-1">
               <h4 className="font-bold text-gray-800 line-clamp-2 mb-1">{article.title}</h4>
               <span className="text-[10px] text-gray-400">{article.dateAdded} åŠ å…¥</span>
            </div>
            <ChevronRight size={16} className="text-gray-300 mt-4"/>
          </div>
        ))
      )}
    </div>
  </div>
);

const MyCashbackView = ({ onBack, points, cashbackBalance, onPay }) => (
  <div className="pb-24 animate-fade-in bg-gray-50 min-h-screen">
     <TopBar title="æˆ‘çš„å›é¥‹é‡‘" onBack={onBack} points={points} />
     <div className="p-6">
        {/* å¡ç‰‡å€å¡Š */}
        <div className="bg-gradient-to-br from-gray-800 to-black text-white p-6 rounded-2xl shadow-xl relative overflow-hidden mb-6">
          <div className="relative z-10">
            <div className="flex justify-between items-start mb-8">
              <span className="text-gray-300 text-sm font-medium">å¯ç”¨é¤˜é¡</span>
              <Coins size={24} className="text-yellow-400"/>
            </div>
            <div className="mb-2">
              <span className="text-4xl font-bold tracking-tight">NT$ {cashbackBalance.toLocaleString()}</span>
            </div>
            <div className="text-xs text-gray-400">
              å¯ç”¨æ–¼é–€å¸‚æ¶ˆè²»æŠ˜æŠµ
            </div>
          </div>
          {/* èƒŒæ™¯è£é£¾ */}
          <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2 blur-2xl"></div>
          <div className="absolute bottom-0 left-0 w-24 h-24 bg-teal-500/20 rounded-full translate-y-1/2 -translate-x-1/2 blur-2xl"></div>
        </div>

        {/* æ“ä½œæŒ‰éˆ• */}
        <button 
          onClick={onPay}
          className="w-full py-4 bg-teal-600 text-white rounded-xl font-bold shadow-lg hover:bg-teal-700 transition active:scale-95 flex items-center justify-center text-lg mb-6"
        >
          <QrCode size={24} className="mr-3"/>
          ç«‹å³æ”¯ä»˜
        </button>

        {/* äº¤æ˜“ç´€éŒ„æ¨¡æ“¬ */}
        <div>
          <h3 className="font-bold text-gray-800 mb-3">æœ€è¿‘ç´€éŒ„</h3>
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 divide-y divide-gray-100">
             {cashbackBalance > 0 ? (
               <div className="p-4 flex justify-between items-center">
                 <div className="flex items-center">
                   <div className="w-10 h-10 bg-green-100 text-green-600 rounded-lg flex items-center justify-center mr-3">
                     <TrendingUp size={20}/>
                   </div>
                   <div>
                     <p className="font-bold text-gray-800">æŒ‘æˆ°è³½å›é¥‹é‡‘</p>
                     <p className="text-xs text-gray-400">{TODAY_DATE}</p>
                   </div>
                 </div>
                 <span className="text-green-600 font-bold">+1,000</span>
               </div>
             ) : (
               <div className="p-8 text-center text-gray-400 text-sm">
                 å°šç„¡äº¤æ˜“ç´€éŒ„
               </div>
             )}
          </div>
        </div>
     </div>
  </div>
);

const ProfileView = ({ 
  planMode, setShowMyCoupons, myItems, showToast, points, onNotificationClick, 
  sharedWithMe, sharedWithOthers, onViewSharedUser, onAddShareClick, 
  onShowFavorites, cashbackBalance, onOpenCashback
}) => (
  <div className="pb-24 animate-fade-in bg-gray-50">
     <TopBar title="å¸³è™Ÿèˆ‡è¨­å®š" points={points} onNotificationClick={onNotificationClick} unreadCount={1} />
     <div className="bg-white p-5 mb-2 flex items-center space-x-4 shadow-sm">
       <div className="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center text-2xl font-bold text-gray-500">é™³</div>
       <div className="flex-1">
         <h2 className="font-bold text-gray-800 text-lg">é™³å¤§æ˜</h2>
         <p className="text-sm text-gray-500">45 æ­² | 0912-345-678</p>
         <div className="flex flex-col mt-1 space-y-1">
           <span className="text-[10px] bg-teal-100 text-teal-700 px-2 py-0.5 rounded w-fit">
             èºç…å¥åº·åŒè¡Œ â€” 90å¤©æ”¹å–„è¨ˆç•«è¨‚é–±è€…
           </span>
           <span className="text-[10px] bg-orange-100 text-orange-800 px-2 py-0.5 rounded w-fit">
             èºç…å¥åº·é€†è½‰ â€” 90å¤©æŒ‘æˆ°è³½è¨‚é–±è€…
           </span>
         </div>
       </div>
       <button onClick={()=>showToast('ç·¨è¼¯å€‹äººè³‡æ–™')} className="text-sm text-teal-600 font-bold border border-teal-600 rounded px-3 py-1">ç·¨è¼¯</button>
     </div>
     
     {/* 1. èˆ‡æˆ‘å…±äº« (Shared With Me) */}
     <div className="bg-white p-4 mb-2 shadow-sm">
        <SectionHeader icon={Users} title="èˆ‡æˆ‘å…±äº«" actionText="" />
        <p className="text-xs text-gray-400 mb-3">ä»¥ä¸‹è¦ªå‹å°‡å¥åº·æ•¸æ“šåˆ†äº«çµ¦æ‚¨ï¼š</p>
        <div className="flex space-x-4 overflow-x-auto pb-2">
           {sharedWithMe.length === 0 ? (
             <p className="text-xs text-gray-400 py-2">ç›®å‰æ²’æœ‰äººèˆ‡æ‚¨å…±äº«è³‡æ–™ã€‚</p>
           ) : (
             sharedWithMe.map(user => (
               <div key={user.id} onClick={() => onViewSharedUser(user)} className="flex flex-col items-center min-w-[70px] cursor-pointer group">
                  <div className="w-14 h-14 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 font-bold mb-2 border-2 border-white shadow-md group-active:scale-95 transition">
                    {user.avatar || user.name[0]}
                  </div>
                  <span className="text-xs font-bold text-gray-700">{user.name}</span>
                  <span className="text-[10px] text-gray-400">({user.relation})</span>
               </div>
             ))
           )}
        </div>
     </div>

     {/* 2. èˆ‡ä»–å…±äº« (Shared With Others) - èª¿æ•´ç‚ºä¸€è‡´æ¨£å¼ */}
     <div className="bg-white p-4 mb-2 shadow-sm">
        <SectionHeader icon={Share2} title="èˆ‡ä»–å…±äº«" actionText="" />
        <p className="text-xs text-gray-400 mb-3">æ‚¨å·²å°‡å¥åº·æ•¸æ“šåˆ†äº«çµ¦ä»¥ä¸‹å°è±¡ (æœ€å¤š3ä½)ï¼š</p>
        <div className="flex space-x-4 overflow-x-auto pb-2 items-start">
           {sharedWithOthers.map(user => (
              <div key={user.id} className="flex flex-col items-center min-w-[70px] cursor-pointer group">
                 <div className="w-14 h-14 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold mb-2 border-2 border-white shadow-md relative opacity-100 transition">
                   {user.avatar || user.name[0]}
                   {/* ç‹€æ…‹æŒ‡ç¤ºé» */}
                   {user.status === 'pending' && <div className="absolute top-0 right-0 w-3 h-3 bg-yellow-400 rounded-full border border-white"></div>}
                 </div>
                 <span className="text-xs font-bold text-gray-700">{user.name}</span>
                 {user.status === 'pending' ? (
                   <span className="text-[10px] text-yellow-600 font-bold bg-yellow-50 px-1 py-0.5 rounded mt-0.5">å¾…ç¢ºèª</span>
                 ) : (
                   <span className="text-[10px] text-gray-400 mt-0.5">({user.relation})</span>
                 )}
              </div>
           ))}

           {sharedWithOthers.length < 3 && (
              <button onClick={onAddShareClick} className="flex flex-col items-center min-w-[70px] group">
                 <div className="w-14 h-14 rounded-full bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 mb-2 group-hover:border-teal-300 group-hover:text-teal-500 transition">
                    <Plus size={24}/>
                 </div>
                 <span className="text-xs font-bold text-gray-400 group-hover:text-teal-500">æ–°å¢</span>
                 <span className="text-[10px] text-transparent">.</span>
              </button>
           )}
        </div>
     </div>

     <div onClick={onShowFavorites} className="bg-white p-4 mb-2 shadow-sm flex items-center justify-between cursor-pointer hover:bg-gray-50"><div className="flex items-center text-gray-700"><Heart size={20} className="mr-3 text-red-500"/><span className="font-bold">æˆ‘çš„æ”¶è—</span></div><div className="flex items-center text-gray-400"><ChevronRight size={16}/></div></div>
     <div onClick={()=>setShowMyCoupons(true)} className="bg-white p-4 mb-2 shadow-sm flex items-center justify-between cursor-pointer hover:bg-gray-50"><div className="flex items-center text-gray-700"><Wallet size={20} className="mr-3 text-teal-600"/><span className="font-bold">æˆ‘çš„ç¥¨åˆ¸å¤¾</span></div><div className="flex items-center text-gray-400"><span className="text-xs mr-2">{myItems.length} å¼µ</span><ChevronRight size={16}/></div></div>
     
     {/* æˆ‘çš„å›é¥‹é‡‘ */}
     <div onClick={onOpenCashback} className="bg-white p-4 mb-2 shadow-sm flex items-center justify-between cursor-pointer hover:bg-gray-50">
       <div className="flex items-center text-gray-700">
         <Coins size={20} className="mr-3 text-yellow-500"/>
         <span className="font-bold">æˆ‘çš„å›é¥‹é‡‘</span>
       </div>
       <div className="flex items-center text-gray-400">
         <span className="text-xs mr-2 font-bold text-gray-800">NT$ {cashbackBalance.toLocaleString()}</span>
         <ChevronRight size={16}/>
       </div>
     </div>

     <div className="bg-white mt-2 shadow-sm divide-y divide-gray-100">{[{label: 'æ–¹æ¡ˆè¨‚é–±èˆ‡ä»˜æ¬¾ç®¡ç†', icon: CreditCard, action: 'ç®¡ç†'}, {label: 'æ¨æ’­é€šçŸ¥è¨­å®š', icon: Bell, action: 'é–‹å•Ÿ'}, {label: 'ä¿å¥å“/ä»»å‹™æé†’é–‹é—œ', icon: Clock, action: 'è¨­å®š'}, {label: 'éš±ç§èˆ‡æ¬Šé™è¨­å®š', icon: Shield, action: 'æŸ¥çœ‹'}, {label: 'è¯çµ¡è—¥å±€ / å®¢æœ', icon: Phone, action: 'æ’¥æ‰“'}].map((item, i) => (<button key={i} onClick={()=>showToast(`é€²å…¥ ${item.label}`)} className="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition"><div className="flex items-center text-gray-700"><item.icon size={20} className="mr-3 text-gray-400"/><span className="text-sm font-medium">{item.label}</span></div><div className="flex items-center text-gray-400 text-xs"><span className="mr-2">{item.action}</span><ChevronRight size={16}/></div></button>))}<button onClick={()=>showToast('å·²ç™»å‡º')} className="w-full flex items-center justify-between p-4 hover:bg-red-50 text-red-500 transition"><div className="flex items-center"><LogOut size={20} className="mr-3"/><span className="text-sm font-medium">ç™»å‡º</span></div></button></div>
  </div>
);

// --- Main App Component ---

export default function YesChainUltimateApp() {
  const [activeTab, setActiveTab] = useState('home');
  const [healthSubTab, setHealthSubTab] = useState(null); 
  const [planMode, setPlanMode] = useState('improve'); 
  const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
  const [showChat, setShowChat] = useState(false);
  const [showFullReport, setShowFullReport] = useState(false);
  const [showMyCoupons, setShowMyCoupons] = useState(false);
  const [showBarcode, setShowBarcode] = useState(null); 
  const [showAddMedModal, setShowAddMedModal] = useState(false); 
  
  // å…±äº«åŠŸèƒ½ç›¸é—œ State
  const [sharedWithMe, setSharedWithMe] = useState(initialSharedWithMe);
  const [sharedWithOthers, setSharedWithOthers] = useState(initialSharedWithOthers);
  const [showAddShareModal, setShowAddShareModal] = useState(false);
  const [viewingSharedUser, setViewingSharedUser] = useState(null); // ç•¶å‰æ­£åœ¨æª¢è¦–çš„å…±äº«è€…
  const [inviteModalData, setInviteModalData] = useState(null); // æ¥æ”¶é‚€è«‹çš„ modal
  
  // å ±å‘Šç›¸é—œ
  const [selectedSimpleReport, setSelectedSimpleReport] = useState(null); 
  const [selectedDetailedReport, setSelectedDetailedReport] = useState(null);
  
  // æ”¶è—ç›¸é—œ
  const [favorites, setFavorites] = useState([]);
  const [showFavorites, setShowFavorites] = useState(false);

  // å›é¥‹é‡‘ç›¸é—œ
  const [cashbackBalance, setCashbackBalance] = useState(0);
  const [hasClaimedCashback, setHasClaimedCashback] = useState(false); // æ–°å¢ï¼šæ˜¯å¦å·²é ˜å–å›é¥‹é‡‘

  // å¥åº·ç´€éŒ„æ•¸æ“š (æ–°å¢: ç”¨ State ç®¡ç†ï¼Œä»¥å³æ™‚æ›´æ–°)
  const [healthRecords, setHealthRecords] = useState(initialHealthData);

  const [tasks, setTasks] = useState(tasksMock);
  const [medications, setMedications] = useState(medicationInitial);
  const [points, setPoints] = useState(1500); 
  const [dailyEarned, setDailyEarned] = useState(0); 
  const [hasCheckedIn, setHasCheckedIn] = useState(false);
  const [myItems, setMyItems] = useState([]); 
  const [notifications, setNotifications] = useState(notificationsInitial);
  const [chatMessages, setChatMessages] = useState([{ id: 1, text: 'æ‚¨å¥½ï¼æˆ‘æ˜¯èºç… AI è—¥å¸«åŠ©ç†ã€‚è«‹é»æ“Šä¸‹æ–¹é¸é …ï¼Œè®“æˆ‘ç‚ºæ‚¨æä¾›å”åŠ©ï¼š', sender: 'bot' }]);
  const chatEndRef = useRef(null);

  const showToast = (message, type = 'success') => {
    setToast({ show: true, message, type });
    setTimeout(() => setToast({ ...toast, show: false }), 2500);
  };

  const handleOptionClick = (option) => {
    setChatMessages(prev => [
      ...prev, 
      { sender: 'user', text: option.label },
      { sender: 'bot', text: option.response }
    ]);
  };

  const earnPoints = (amount, sourceName) => {
    if (dailyEarned >= MAX_DAILY_POINTS) {
      showToast(`${sourceName}å®Œæˆï¼(ä»Šæ—¥å·²é”ä¸Šé™)`, 'info');
      return false; 
    }
    const remainingQuota = MAX_DAILY_POINTS - dailyEarned;
    const actualEarned = Math.min(amount, remainingQuota);
    setPoints(prev => prev + actualEarned);
    setDailyEarned(prev => prev + actualEarned);
    showToast(`${sourceName}æˆåŠŸï¼ç²å¾— ${actualEarned} é»`);
    return true;
  };

  const handleCheckIn = () => {
    if (hasCheckedIn) return showToast('ä»Šæ—¥å·²ç¶“ç°½åˆ°éäº†å–”ï¼', 'info');
    earnPoints(10, 'æ¯æ—¥ç°½åˆ°');
    setHasCheckedIn(true); 
  };

  const toggleTask = (id) => {
    setTasks(tasks.map(t => {
      if (t.id === id && !t.completed) {
        earnPoints(t.points, 'ä»»å‹™å®Œæˆ');
        return { ...t, completed: true };
      }
      return t;
    }));
  };

  const takeMedication = (id) => {
    setMedications(prev => prev.map(med => {
      if (med.id === id && !med.taken) {
        earnPoints(5, 'æº–æ™‚æœè—¥'); 
        return { ...med, taken: true, stock: med.stock - 1 };
      }
      return med;
    }));
  };

  const handleAddMedication = (newMed) => {
    if(!newMed.name) return showToast('è«‹è¼¸å…¥è—¥ç‰©åç¨±', 'error');
    const newItem = { id: Date.now(), ...newMed, unit: 'é¡†', taken: false };
    setMedications([...medications, newItem]);
    setShowAddMedModal(false);
    showToast('ç”¨è—¥æé†’å·²æ–°å¢');
  };

  const handleRedeem = (item) => {
    if (points < item.cost) {
      showToast(`é»æ•¸é‚„å·® ${item.cost - points} é»å–”ï¼åŠ æ²¹ ğŸ’ª`, 'error');
      return;
    }
    setPoints(prev => prev - item.cost);
    const newItem = { ...item, redeemDate: TODAY_DATE, uid: Date.now() };
    setMyItems(prev => [newItem, ...prev]);
    showToast(`å…Œæ›æˆåŠŸï¼å·²å­˜å…¥ã€Œæˆ‘çš„ç¥¨åˆ¸å¤¾ã€`);
  };

  const handleOpenDetailedReport = (reportOrId) => {
    // æ”¯æ´ç›´æ¥å‚³ç‰©ä»¶æˆ– ID
    const report = typeof reportOrId === 'object' ? reportOrId : reportsMock.find(r => r.id === reportOrId);
    if (report) {
      setSelectedDetailedReport(report);
    }
  };

  const handleOpenSimpleReport = (report) => {
    setSelectedSimpleReport(report);
  };

  // --- å…±äº«åŠŸèƒ½è™•ç† ---

  // 1. ç™¼é€é‚€è«‹ (æ–°å¢èˆ‡ä»–å…±äº«)
  const handleAddShare = (data) => {
    if (!data.name) return showToast('è«‹è¼¸å…¥å§“å', 'error');
    // æ³¨æ„ï¼šæ‰‹æ©Ÿæ ¼å¼é©—è­‰å·²ç§»è‡³ Modal å…§éƒ¨è™•ç†
    const newUser = { id: Date.now().toString(), name: data.name, relation: data.relation, status: 'pending', avatar: data.name[0] };
    setSharedWithOthers([...sharedWithOthers, newUser]);
    setShowAddShareModal(false);
    showToast(`å·²ç™¼é€é‚€è«‹çµ¦ ${data.name}`);
  };

  // 2. é»æ“Šé€šçŸ¥ä¸­çš„é‚€è«‹
  const handleInviteClick = (notif) => {
    setInviteModalData({ payload: notif.payload, notifId: notif.id });
  };

  // 3. æ¥å—é‚€è«‹
  const handleAcceptInvite = (invite) => {
    const newUser = { id: invite.payload.id, name: invite.payload.name, relation: invite.payload.relation, avatar: invite.payload.name[0] };
    setSharedWithMe([...sharedWithMe, newUser]);
    // æ¨™è¨˜é€šçŸ¥å·²è®€æˆ–ç§»é™¤
    setNotifications(prev => prev.filter(n => n.id !== invite.notifId));
    setInviteModalData(null);
    showToast(`æ‚¨å·²æˆç‚º ${newUser.name} çš„å…±äº«è€…`, 'success');
  };

  // 4. æ‹’çµ•é‚€è«‹
  const handleDeclineInvite = (invite) => {
    setNotifications(prev => prev.filter(n => n.id !== invite.notifId));
    setInviteModalData(null);
    showToast(`å·²æ‹’çµ• ${invite.payload.name} çš„é‚€è«‹`, 'info');
  };

  // 5. é–‹å•Ÿå…±äº«ä½¿ç”¨è€… (é¦–é é»æ“Šæ¯è¦ª)
  const handleOpenSharedUser = (user) => {
    setViewingSharedUser(user);
  }

  // 6. é ˜å–å›é¥‹é‡‘
  const handleClaimCashback = () => {
    if (hasClaimedCashback) return;
    setCashbackBalance(prev => prev + 1000);
    setHasClaimedCashback(true);
    showToast('å·²æˆåŠŸé ˜å–å›é¥‹é‡‘ NT$ 1,000', 'success');
  }

  // --- å¥åº·æ•¸æ“šæ›´æ–°è™•ç† (æ–°å¢) ---
  const updateHealthRecord = (updates) => {
     setHealthRecords(prev => {
        // æª¢æŸ¥æ˜¯å¦å·²æœ‰ä»Šæ—¥çš„æ•¸æ“š
        const todayIndex = prev.findIndex(r => r.fullDate === TODAY_DATE);
        
        if (todayIndex >= 0) {
           // å¦‚æœæœ‰ï¼Œæ›´æ–°è©²ç­†è³‡æ–™
           const newRecords = [...prev];
           newRecords[todayIndex] = { ...newRecords[todayIndex], ...updates };
           return newRecords;
        } else {
           // å¦‚æœæ²’æœ‰ï¼Œå‰µå»ºä¸€ç­†ä»Šæ—¥çš„æ–°è³‡æ–™ (ç¹¼æ‰¿æ˜¨å¤©çš„å…¶ä»–æ•¸å€¼ä»¥å…åœ–è¡¨æ–·è£‚)
           const yesterday = prev[prev.length - 1];
           const newRecord = {
              fullDate: TODAY_DATE,
              date: TODAY_DATE.slice(5),
              sys: yesterday?.sys || 120,
              dia: yesterday?.dia || 80,
              sugar: yesterday?.sugar || 100,
              weight: yesterday?.weight || 68,
              sleep: yesterday?.sleep || 7,
              ...updates
           };
           return [...prev, newRecord];
        }
     });
  };

  const handleUpdateBP = (sys, dia) => {
     if (!sys || !dia) return showToast('è«‹è¼¸å…¥æ”¶ç¸®å£“èˆ‡èˆ’å¼µå£“', 'error');
     updateHealthRecord({ sys: Number(sys), dia: Number(dia) });
     showToast('è¡€å£“ç´€éŒ„æˆåŠŸï¼Œåœ–è¡¨å·²æ›´æ–°');
     earnPoints(5, 'æ¸¬é‡è¡€å£“');
     // ä¸é—œé–‰é é¢ï¼Œè®“ä½¿ç”¨è€…æŸ¥çœ‹åœ–è¡¨
  };

  const handleUpdateSugar = (val) => {
     if (!val) return showToast('è«‹è¼¸å…¥è¡€ç³–æ•¸å€¼', 'error');
     updateHealthRecord({ sugar: Number(val) });
     showToast('è¡€ç³–ç´€éŒ„æˆåŠŸï¼Œåœ–è¡¨å·²æ›´æ–°');
     earnPoints(5, 'æ¸¬é‡è¡€ç³–');
  };

  const handleUpdateWeight = (val) => {
     if (!val) return showToast('è«‹è¼¸å…¥é«”é‡', 'error');
     updateHealthRecord({ weight: Number(val) });
     showToast('é«”é‡ç´€éŒ„æˆåŠŸï¼Œåœ–è¡¨å·²æ›´æ–°');
     earnPoints(5, 'é‡é«”é‡');
  };

  const handleUpdateSleep = (val) => {
     if (!val) return showToast('è«‹è¼¸å…¥ç¡çœ æ™‚æ•¸', 'error');
     updateHealthRecord({ sleep: Number(val) });
     showToast('ç¡çœ ç´€éŒ„æˆåŠŸï¼Œåœ–è¡¨å·²æ›´æ–°');
     earnPoints(5, 'ç´€éŒ„ç¡çœ ');
  };

  const handleSaveDiet = () => {
     showToast('é£²é£Ÿç´€éŒ„æˆåŠŸ');
     earnPoints(5, 'ç´€éŒ„é£²é£Ÿ');
     // é£²é£Ÿä¸éœ€æ›´æ–°åœ–è¡¨ï¼Œä¹Ÿä¸é—œé–‰é é¢
  };

  const handleSaveExercise = () => {
     showToast('é‹å‹•ç´€éŒ„æˆåŠŸ');
     earnPoints(10, 'ç´€éŒ„é‹å‹•');
     // é‹å‹•ä¸éœ€æ›´æ–°åœ–è¡¨ï¼Œä¹Ÿä¸é—œé–‰é é¢
  };

  return (
    <div className="w-full max-w-md mx-auto h-screen bg-gray-100 relative shadow-2xl overflow-hidden font-sans">
      <div className="h-full overflow-y-auto scrollbar-hide">
         {showMyCoupons ? (
            <MyCouponsView myItems={myItems} setShowMyCoupons={setShowMyCoupons} setShowBarcode={setShowBarcode} setActiveTab={setActiveTab} points={points} onNotificationClick={() => setActiveTab('notifications')} />
         ) : showFavorites ? (
            <FavoritesView onBack={() => setShowFavorites(false)} points={points} favorites={favorites} />
         ) : activeTab === 'cashback' ? (
            <MyCashbackView 
              onBack={() => setActiveTab('profile')} 
              points={points} 
              cashbackBalance={cashbackBalance}
              onPay={() => setShowBarcode({ title: 'å›é¥‹é‡‘æ”¯ä»˜', desc: 'é–€å¸‚æ¶ˆè²»æŠ˜æŠµ', uid: 'PAY-' + Date.now(), type: 'payment' })}
            />
         ) : selectedDetailedReport ? (
            /* è©³ç´°ç‰ˆæœˆå ± */
            <DetailedReportModal report={selectedDetailedReport} onClose={() => setSelectedDetailedReport(null)} longTermData={healthRecords} points={points} showToast={showToast} />
         ) : selectedSimpleReport ? (
            /* ç°¡å–®ç‰ˆæœˆå ± */
            <SimpleReportModal report={selectedSimpleReport} onClose={() => setSelectedSimpleReport(null)} longTermData={healthRecords} points={points} />
         ) : (
            <>
               {activeTab === 'home' && (
                 <HomeView 
                   dailyEarned={dailyEarned} handleCheckIn={handleCheckIn} hasCheckedIn={hasCheckedIn} 
                   points={points} setActiveTab={setActiveTab} medications={medications} 
                   takeMedication={takeMedication} setShowAddMedModal={setShowAddMedModal} 
                   showToast={showToast} tasks={tasks} toggleTask={toggleTask}
                   onNotificationClick={() => setActiveTab('notifications')}
                   handleOpenSharedUser={handleOpenSharedUser}
                 />
               )}
               {activeTab === 'notifications' && (
                 <NotificationView 
                    onBack={() => setActiveTab('home')} 
                    onOpenReport={handleOpenDetailedReport}
                    onInviteClick={handleInviteClick}
                    points={points}
                    notifications={notifications}
                    setNotifications={setNotifications}
                    setActiveTab={setActiveTab}
                 />
               )}
               {activeTab === 'coupons' && <RedeemView type="coupon" points={points} setActiveTab={setActiveTab} setShowMyCoupons={setShowMyCoupons} handleRedeem={handleRedeem} myItems={myItems} onNotificationClick={() => setActiveTab('notifications')} />}
               {activeTab === 'gifts' && <RedeemView type="gift" points={points} setActiveTab={setActiveTab} setShowMyCoupons={setShowMyCoupons} handleRedeem={handleRedeem} myItems={myItems} onNotificationClick={() => setActiveTab('notifications')} />}
               
               {activeTab === 'edu' && <EduView setShowChat={setShowChat} showToast={showToast} points={points} setPoints={setPoints} onNotificationClick={() => setActiveTab('notifications')} favorites={favorites} setFavorites={setFavorites} />}
               
               {activeTab === 'health' && (
                  <HealthView 
                    points={points} showToast={showToast} 
                    subTab={healthSubTab} setSubTab={setHealthSubTab}
                    medications={medications}
                    onNotificationClick={() => setActiveTab('notifications')}
                    onViewSimpleReport={handleOpenSimpleReport}
                    healthRecords={healthRecords}
                    onUpdateBP={handleUpdateBP}
                    onUpdateSugar={handleUpdateSugar}
                    onUpdateWeight={handleUpdateWeight}
                    onUpdateSleep={handleUpdateSleep}
                    onSaveDiet={handleSaveDiet}
                    onSaveExercise={handleSaveExercise}
                  />
               )}
               
               {activeTab === 'plan' && <PlanView planMode={planMode} setPlanMode={setPlanMode} showToast={showToast} points={points} onNotificationClick={() => setActiveTab('notifications')} setShowBarcode={setShowBarcode} onClaimCashback={handleClaimCashback} hasClaimedCashback={hasClaimedCashback} />}
               
               {activeTab === 'profile' && (
                  <ProfileView 
                    planMode={planMode} 
                    setShowMyCoupons={setShowMyCoupons} 
                    myItems={myItems} 
                    showToast={showToast} 
                    points={points}
                    onNotificationClick={() => setActiveTab('notifications')}
                    sharedWithMe={sharedWithMe}
                    sharedWithOthers={sharedWithOthers}
                    onViewSharedUser={setViewingSharedUser}
                    onAddShareClick={() => setShowAddShareModal(true)}
                    onShowFavorites={() => setShowFavorites(true)}
                    cashbackBalance={cashbackBalance}
                    onOpenCashback={() => setActiveTab('cashback')}
                  />
               )}
            </>
         )}
      </div>

      <BarcodeModal showBarcode={showBarcode} setShowBarcode={setShowBarcode} />
      {showAddMedModal && <AddMedicationModal onClose={()=>setShowAddMedModal(false)} onAdd={handleAddMedication} />}
      <FullReportView showFullReport={showFullReport} setShowFullReport={setShowFullReport} showToast={showToast} />
      <ChatOverlay showChat={showChat} setShowChat={setShowChat} chatMessages={chatMessages} handleOptionClick={handleOptionClick} chatEndRef={chatEndRef} />
      
      {/* å…±äº«ç›¸é—œ Modals */}
      <AddShareModal show={showAddShareModal} onClose={() => setShowAddShareModal(false)} onAdd={handleAddShare} />
      <InviteConfirmModal invite={inviteModalData} onClose={() => setInviteModalData(null)} onAccept={handleAcceptInvite} onDecline={handleDeclineInvite} />
      <SharedUserView user={viewingSharedUser} onClose={() => setViewingSharedUser(null)} onOpenReport={handleOpenDetailedReport} showToast={showToast} />

      <div className={`fixed top-16 left-1/2 transform -translate-x-1/2 bg-gray-800/90 backdrop-blur text-white px-4 py-2 rounded-full text-sm shadow-xl transition-all duration-300 pointer-events-none flex items-center z-[80] ${toast.show ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-4'}`}>
         {toast.type === 'error' ? <AlertCircle size={16} className="mr-2 text-red-400"/> : <CheckCircle size={16} className="mr-2 text-teal-400"/>}
         {toast.message}
      </div>

      <div className="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 py-2 px-4 flex justify-between items-center z-40 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
         {[
            {id: 'home', icon: Home, label: 'é¦–é '},
            {id: 'edu', icon: BookOpen, label: 'è¡›æ•™'},
            {id: 'health', icon: Activity, label: 'ç´€éŒ„'},
            {id: 'plan', icon: Heart, label: 'æ–¹æ¡ˆ'},
            {id: 'profile', icon: User, label: 'æˆ‘çš„'},
         ].map(item => {
            const isActive = activeTab === item.id || (item.id === 'home' && activeTab === 'notifications'); 
            return (
               <button key={item.id} onClick={()=>{setActiveTab(item.id); setHealthSubTab(null); setShowMyCoupons(false); setShowFavorites(false); setSelectedDetailedReport(null); setSelectedSimpleReport(null); setViewingSharedUser(null);}} className={`flex flex-col items-center w-12 transition ${isActive ? 'text-teal-700' : 'text-gray-400'}`}>
                  <div className={`mb-1 ${isActive ? 'translate-y-[-2px]' : ''} transition-transform`}>
                     <item.icon size={24} strokeWidth={isActive ? 2.5 : 2} fill={isActive && item.id !== 'health' && item.id !== 'profile' ? 'currentColor' : 'none'} />
                  </div>
                  <span className="text-[10px] font-bold">{item.label}</span>
               </button>
            )
         })}
      </div>
    </div>
  );
}